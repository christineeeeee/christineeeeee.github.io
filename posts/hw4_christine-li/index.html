<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="theme-color" content="#999686">
    <meta name="viewport" content="initial-scale=1, viewport-fit=cover, width=device-width"></meta>
    <meta name="apple-mobile-web-app-capable" content="yes"></meta>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"></meta>

    <meta name="author" content="Christine">
    
    

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Quantile Trading"/>
<meta name="twitter:description" content="This is a strategy which we trade different securities by ranking their performance and using their quantile as signals.
1. Data preparation Introduction of the packages we used We&rsquo;re using several really important python packages in this strategy:
 Pandas: dataframe manipulation NumPy: support for mathematical functions and computation of arrays and matrics Quandl: source of our future data Statsmodel: statistical analysis Matplotlib: plot tools Seaborn: statistical data visualization Glob: retrieve files matching a specified pattern os: interact with the operating system tqdm: progress bar  1 2 3 4 5 6 7 8 9 10 11 12 13 14  import os import numpy as np import pandas as pd import pickle import quandl import warnings from functools import reduce from tqdm."/>

    <meta property="og:title" content="Quantile Trading" />
<meta property="og:description" content="This is a strategy which we trade different securities by ranking their performance and using their quantile as signals.
1. Data preparation Introduction of the packages we used We&rsquo;re using several really important python packages in this strategy:
 Pandas: dataframe manipulation NumPy: support for mathematical functions and computation of arrays and matrics Quandl: source of our future data Statsmodel: statistical analysis Matplotlib: plot tools Seaborn: statistical data visualization Glob: retrieve files matching a specified pattern os: interact with the operating system tqdm: progress bar  1 2 3 4 5 6 7 8 9 10 11 12 13 14  import os import numpy as np import pandas as pd import pickle import quandl import warnings from functools import reduce from tqdm." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://christineeeeee.com/posts/hw4_christine-li/" />
<meta property="article:published_time" content="2020-04-15T12:45:00+00:00" />
<meta property="article:modified_time" content="2020-04-15T12:45:00+00:00" />


    
      <base href="https://christineeeeee.com/posts/hw4_christine-li/">
    
    <title>
  Quantile Trading · Christine&#39;s Shattered Life
</title>

    
      <link rel="canonical" href="https://christineeeeee.com/posts/hw4_christine-li/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.c6a6f7e4e5b9eae62968f9dee6cad8903a7a12c11df9305249ee05c53679cafe.css" integrity="sha256-xqb35OW56uYpaPne5srYkDp6EsEd&#43;TBSSe4FxTZ5yv4=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="/css/custom.css" />
    

    

    

    <link rel="icon" type="image/png" href="https://christineeeeee.com/images/avatar.jpg" sizes="32x32">
    <link rel="icon" type="image/png" href="https://christineeeeee.com/images/avatar.jpg" sizes="16x16">

    <meta name="generator" content="Hugo 0.63.1" />

  </head>

  
  
  <body class="colorscheme-light">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      Christine&#39;s Shattered Life
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://christineeeeee.com/posts/">Posts</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://christineeeeee.com/pieces/">Pieces</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://christineeeeee.com/newsletter/">Newsletter</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://christineeeeee.com/about/">About</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Quantile Trading</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-04-15T12:45:00Z'>
                April 15, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              15-minute read
            </span>
          </div>
          
          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="/tags/python/">Python</a>
      <span class="separator">•</span>
    <a href="/tags/strategy/">Strategy</a></div>

        </div>
      </header>

      <div>
        
        <p>This is a strategy which we trade different securities by ranking their performance and using their quantile as signals.</p>
<h2 id="1-data-preparation">1. Data preparation</h2>
<h3 id="introduction-of-the-packages-we-used">Introduction of the packages we used</h3>
<p>We&rsquo;re using several really important python packages in this strategy:</p>
<ul>
<li><strong>Pandas</strong>: dataframe manipulation</li>
<li><strong>NumPy</strong>: support for mathematical functions and computation of arrays and matrics</li>
<li><strong>Quandl</strong>: source of our future data</li>
<li><strong>Statsmodel</strong>: statistical analysis</li>
<li><strong>Matplotlib</strong>: plot tools</li>
<li><strong>Seaborn</strong>: statistical data visualization</li>
<li><strong>Glob</strong>: retrieve files matching a specified pattern</li>
<li><strong>os</strong>: interact with the operating system</li>
<li><strong>tqdm</strong>: progress bar</li>
</ul>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> <span style="color:#111">os</span>
<span style="color:#f92672">import</span> <span style="color:#111">numpy</span> <span style="color:#f92672">as</span> <span style="color:#111">np</span>
<span style="color:#f92672">import</span> <span style="color:#111">pandas</span> <span style="color:#f92672">as</span> <span style="color:#111">pd</span>
<span style="color:#f92672">import</span> <span style="color:#111">pickle</span>
<span style="color:#f92672">import</span> <span style="color:#111">quandl</span>
<span style="color:#f92672">import</span> <span style="color:#111">warnings</span>
<span style="color:#f92672">from</span> <span style="color:#111">functools</span> <span style="color:#f92672">import</span> <span style="color:#111">reduce</span>
<span style="color:#f92672">from</span> <span style="color:#111">tqdm.auto</span> <span style="color:#f92672">import</span> <span style="color:#111">tqdm</span>
<span style="color:#f92672">import</span> <span style="color:#111">matplotlib.pyplot</span> <span style="color:#f92672">as</span> <span style="color:#111">plt</span>
<span style="color:#f92672">import</span> <span style="color:#111">statsmodels.formula.api</span> <span style="color:#f92672">as</span> <span style="color:#111">smf</span>

<span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">set_option</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">display.max_rows</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">20</span><span style="color:#111">)</span>
<span style="color:#111">warnings</span><span style="color:#f92672">.</span><span style="color:#111">filterwarnings</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">ignore</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">rcParams</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">figure.figsize</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="data-cleaning">Data Cleaning</h3>
<p>We load our ZFB and EOD datasets from Quandl in this part, including a strict filteration process that only keeps:</p>
<ul>
<li>EOD adjusted closing prices are available</li>
<li>Maximum of debt/market cap ratio is greater3 than 0.1</li>
<li>Not in automotive, financial or insurance sector</li>
<li>No more than one year old as determined by filing dates</li>
</ul>
<p>We set the constant funding rate as 0 in our strategy.</p>
<h4 id="import-zfb">Import ZFB</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">keys</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ticker</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_end_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
<span style="color:#111">z1</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ZACKS_1.csv</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">usecols</span><span style="color:#f92672">=</span><span style="color:#111">keys</span> <span style="color:#f92672">+</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">mkt_val</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">cols</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">nbr_shares_out</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">filing_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">net_lterm_debt</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">tot_lterm_debt</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_type</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span>
        <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">eps_diluted_net</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">basic_net_eps</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">zacks_sector_code</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">zacks_x_ind_code</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
<span style="color:#111">z2</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ZACKS_5.csv</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">usecols</span><span style="color:#f92672">=</span><span style="color:#111">keys</span> <span style="color:#f92672">+</span> <span style="color:#111">cols</span><span style="color:#111">)</span>
<span style="color:#111">z3</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ZACKS_3.csv</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">usecols</span><span style="color:#f92672">=</span><span style="color:#111">keys</span> <span style="color:#f92672">+</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">tot_debt_tot_equity</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_type</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ret_invst</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>

<span style="color:#00a8c8">def</span> <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#00a8c8">assert</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span><span style="color:#111">:</span>
        <span style="color:#111">x</span> <span style="color:#f92672">=</span> <span style="color:#111">x</span><span style="color:#111">[</span><span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">per_type</span><span style="color:#f92672">==</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Q</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">[</span><span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">per_type</span><span style="color:#f92672">==</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">A</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">reset_index</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">drop</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">index</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ticker</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_type</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_end_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>

<span style="color:#111">zacks</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">tqdm</span><span style="color:#111">(</span><span style="color:#111">set</span><span style="color:#111">(</span><span style="color:#111">z1</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ticker</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">temp1</span> <span style="color:#f92672">=</span> <span style="color:#111">z1</span><span style="color:#111">[</span><span style="color:#111">z1</span><span style="color:#f92672">.</span><span style="color:#111">ticker</span><span style="color:#f92672">==</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">drop</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ticker</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">set_index</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_end_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
    
    <span style="color:#111">temp2</span> <span style="color:#f92672">=</span> <span style="color:#111">z2</span><span style="color:#111">[</span><span style="color:#111">z2</span><span style="color:#f92672">.</span><span style="color:#111">ticker</span><span style="color:#f92672">==</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">groupby</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_end_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">apply</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">temp2</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
        <span style="color:#00a8c8">continue</span>
    <span style="color:#111">temp2</span> <span style="color:#f92672">=</span> <span style="color:#111">temp2</span><span style="color:#f92672">.</span><span style="color:#111">droplevel</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
    
    <span style="color:#111">temp3</span> <span style="color:#f92672">=</span> <span style="color:#111">z3</span><span style="color:#111">[</span><span style="color:#111">z3</span><span style="color:#f92672">.</span><span style="color:#111">ticker</span><span style="color:#f92672">==</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">groupby</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_end_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">apply</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">temp3</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
        <span style="color:#00a8c8">continue</span>
    <span style="color:#111">temp3</span> <span style="color:#f92672">=</span> <span style="color:#111">temp3</span><span style="color:#f92672">.</span><span style="color:#111">droplevel</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
    
    <span style="color:#111">temp</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">temp1</span><span style="color:#111">,</span> <span style="color:#111">temp2</span><span style="color:#111">,</span> <span style="color:#111">temp3</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">sort_index</span><span style="color:#111">(</span><span style="color:#111">)</span>
    <span style="color:#111">temp</span> <span style="color:#f92672">=</span> <span style="color:#111">temp</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">2012-01</span><span style="color:#d88200">&#39;</span><span style="color:#111">:</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">2020-01</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
    <span style="color:#111">temp</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Debt_To_Mkt_Cap</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">temp</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">tot_debt_tot_equity</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">/</span> <span style="color:#111">temp</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">mkt_val</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
    <span style="color:#111">temp</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Debt_To_Mkt_Cap</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">2012-09-30</span><span style="color:#d88200">&#39;</span><span style="color:#111">:</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">2012-09-30</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
    <span style="color:#111">zacks</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">temp</span>

<span style="color:#111">temp</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">zacks</span><span style="color:#111">,</span> <span style="color:#111">keys</span><span style="color:#f92672">=</span><span style="color:#111">zacks</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">reset_index</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">temp</span><span style="color:#f92672">.</span><span style="color:#111">drop</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">c</span> <span style="color:#00a8c8">for</span> <span style="color:#111">c</span> <span style="color:#f92672">in</span> <span style="color:#111">temp</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#00a8c8">if</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">:</span><span style="color:#d88200">&#39;</span> <span style="color:#f92672">in</span> <span style="color:#111">c</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#111">inplace</span><span style="color:#f92672">=</span><span style="color:#111">True</span><span style="color:#111">)</span>
<span style="color:#111">temp</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ticker</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">+</span> <span style="color:#111">list</span><span style="color:#111">(</span><span style="color:#111">temp</span><span style="color:#f92672">.</span><span style="color:#111">columns</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">:</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">temp</span><span style="color:#f92672">.</span><span style="color:#111">to_csv</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">../HW4/zacks.csv</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">ZFB</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">../HW4/zacks.csv</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">index_col</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">ZFB</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>id</th>
<th>ticker</th>
<th>per_end_date</th>
<th>mkt_val</th>
<th>zacks_sector_code</th>
<th>zacks_x_ind_code</th>
<th>filing_date</th>
<th>nbr_shares_out</th>
<th>basic_net_eps</th>
<th>tot_lterm_debt</th>
<th>net_lterm_debt</th>
<th>eps_diluted_net</th>
<th>tot_debt_tot_equity</th>
<th>ret_invst</th>
<th>Debt_To_Mkt_Cap</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>DOOO</td>
<td>2017-01-31</td>
<td>NaN</td>
<td>5.0</td>
<td>10.0</td>
<td>NaN</td>
<td>NaN</td>
<td>0.91</td>
<td>NaN</td>
<td>NaN</td>
<td>0.91</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<td>1</td>
<td>DOOO</td>
<td>2017-04-30</td>
<td>NaN</td>
<td>5.0</td>
<td>10.0</td>
<td>NaN</td>
<td>NaN</td>
<td>-0.13</td>
<td>NaN</td>
<td>NaN</td>
<td>-0.13</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<td>2</td>
<td>DOOO</td>
<td>2017-07-31</td>
<td>NaN</td>
<td>5.0</td>
<td>10.0</td>
<td>NaN</td>
<td>NaN</td>
<td>0.68</td>
<td>NaN</td>
<td>NaN</td>
<td>0.67</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<td>3</td>
<td>DOOO</td>
<td>2017-10-31</td>
<td>NaN</td>
<td>5.0</td>
<td>10.0</td>
<td>NaN</td>
<td>NaN</td>
<td>0.60</td>
<td>NaN</td>
<td>NaN</td>
<td>0.60</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<td>4</td>
<td>DOOO</td>
<td>2018-01-31</td>
<td>NaN</td>
<td>5.0</td>
<td>10.0</td>
<td>NaN</td>
<td>NaN</td>
<td>0.89</td>
<td>752.750</td>
<td>NaN</td>
<td>0.89</td>
<td>-17.2607</td>
<td>12.8604</td>
<td>NaN</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
<tr>
<td>219351</td>
<td>NEFF</td>
<td>2016-09-30</td>
<td>226.69</td>
<td>7.0</td>
<td>286.0</td>
<td>2016-10-26</td>
<td>23863590.0</td>
<td>NaN</td>
<td>733.843</td>
<td>3.051</td>
<td>0.31</td>
<td>-4.8868</td>
<td>2.2996</td>
<td>-0.021557</td>
</tr>
<tr>
<td>219352</td>
<td>NEFF</td>
<td>2016-12-31</td>
<td>335.72</td>
<td>7.0</td>
<td>286.0</td>
<td>2017-03-06</td>
<td>17885380.0</td>
<td>NaN</td>
<td>691.391</td>
<td>-30.549</td>
<td>0.53</td>
<td>-5.2487</td>
<td>2.9126</td>
<td>-0.015634</td>
</tr>
<tr>
<td>219353</td>
<td>NEFF</td>
<td>2017-03-31</td>
<td>463.20</td>
<td>7.0</td>
<td>286.0</td>
<td>2017-04-26</td>
<td>23814710.0</td>
<td>NaN</td>
<td>677.773</td>
<td>-14.230</td>
<td>0.18</td>
<td>-5.4337</td>
<td>1.1278</td>
<td>-0.011731</td>
</tr>
<tr>
<td>219354</td>
<td>NEFF</td>
<td>2017-06-30</td>
<td>453.04</td>
<td>7.0</td>
<td>286.0</td>
<td>2017-08-03</td>
<td>23844420.0</td>
<td>NaN</td>
<td>680.271</td>
<td>-12.130</td>
<td>0.34</td>
<td>-6.0733</td>
<td>2.1708</td>
<td>-0.013406</td>
</tr>
<tr>
<td>219355</td>
<td>NEFF</td>
<td>2017-09-30</td>
<td>596.11</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">eps_diluted_net</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">basic_net_eps</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">inplace</span><span style="color:#f92672">=</span><span style="color:#111">True</span><span style="color:#111">)</span>

<span style="color:#111">con1</span> <span style="color:#f92672">=</span> <span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#111">(</span><span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">zacks_sector_code</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span><span style="color:#111">]</span> 
<span style="color:#111">con2</span> <span style="color:#f92672">=</span> <span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#111">(</span><span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">zacks_sector_code</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">13</span><span style="color:#111">)</span><span style="color:#111">]</span>
<span style="color:#111">con3</span> <span style="color:#f92672">=</span> <span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#111">(</span><span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">zacks_x_ind_code</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">isin</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#ae81ff">85</span><span style="color:#111">,</span> <span style="color:#ae81ff">86</span><span style="color:#111">,</span> <span style="color:#ae81ff">87</span><span style="color:#111">,</span> <span style="color:#ae81ff">88</span><span style="color:#111">,</span> <span style="color:#ae81ff">89</span><span style="color:#111">,</span> <span style="color:#ae81ff">61</span><span style="color:#111">,</span> <span style="color:#ae81ff">62</span><span style="color:#111">,</span> <span style="color:#ae81ff">63</span><span style="color:#111">,</span> <span style="color:#ae81ff">64</span><span style="color:#111">,</span> <span style="color:#ae81ff">65</span><span style="color:#111">,</span> <span style="color:#ae81ff">66</span><span style="color:#111">,</span> <span style="color:#ae81ff">67</span> <span style="color:#111">,</span><span style="color:#ae81ff">68</span> <span style="color:#111">,</span><span style="color:#ae81ff">69</span><span style="color:#111">,</span> <span style="color:#ae81ff">282</span><span style="color:#111">,</span> <span style="color:#ae81ff">7</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">,</span> <span style="color:#ae81ff">9</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#ae81ff">11</span><span style="color:#111">,</span> <span style="color:#ae81ff">82</span><span style="color:#111">,</span> <span style="color:#ae81ff">124</span><span style="color:#111">,</span> <span style="color:#ae81ff">210</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">]</span>  <span style="color:#75715e"># filter industry</span>
<span style="color:#111">con4</span> <span style="color:#f92672">=</span> <span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#111">(</span><span style="color:#111">(</span><span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">basic_net_eps</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">isna</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">(</span><span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">eps_diluted_net</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">isna</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">]</span>

<span style="color:#111">ticker_out</span> <span style="color:#f92672">=</span> <span style="color:#111">set</span><span style="color:#111">(</span><span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">con1</span><span style="color:#111">,</span> <span style="color:#111">con2</span><span style="color:#111">,</span> <span style="color:#111">con3</span><span style="color:#111">,</span> <span style="color:#111">con4</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">set_index</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ticker</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span>
<span style="color:#111">ZFB_update</span> <span style="color:#f92672">=</span> <span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#f92672">~</span><span style="color:#111">(</span><span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ticker</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">isin</span><span style="color:#111">(</span><span style="color:#111">ticker_out</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">set_index</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ticker</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">ticker_update</span> <span style="color:#f92672">=</span> <span style="color:#111">set</span><span style="color:#111">(</span><span style="color:#111">ZFB_update</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="import-eod-from-quandl">Import EOD from Quandl</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">start_date</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">2012-01-01</span><span style="color:#d88200">&#39;</span>
<span style="color:#111">end_date</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">2019-01-31</span><span style="color:#d88200">&#39;</span>
<span style="color:#111">n</span> <span style="color:#f92672">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">ticker_update</span><span style="color:#111">)</span>

<span style="color:#00a8c8">def</span> <span style="color:#75af00">get_eod</span><span style="color:#111">(</span><span style="color:#111">tic</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">quandl</span><span style="color:#f92672">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">EOD/{tic}</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">start_date</span><span style="color:#f92672">=</span><span style="color:#111">start_date</span><span style="color:#111">,</span> <span style="color:#111">end_date</span><span style="color:#f92672">=</span><span style="color:#111">end_date</span><span style="color:#111">)</span>


<span style="color:#00a8c8">if</span> <span style="color:#111">os</span><span style="color:#f92672">.</span><span style="color:#111">path</span><span style="color:#f92672">.</span><span style="color:#111">isfile</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">EOD.pkl</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#00a8c8">with</span> <span style="color:#111">open</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">EOD.pkl</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">rb</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">f</span><span style="color:#111">:</span>
        <span style="color:#111">EOD</span> <span style="color:#f92672">=</span> <span style="color:#111">pickle</span><span style="color:#f92672">.</span><span style="color:#111">load</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#111">)</span>
<span style="color:#00a8c8">else</span><span style="color:#111">:</span>
    <span style="color:#111">EOD</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span><span style="color:#111">}</span>
    <span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">tqdm</span><span style="color:#111">(</span><span style="color:#111">ticker_update</span><span style="color:#111">)</span><span style="color:#111">:</span>
        <span style="color:#00a8c8">try</span><span style="color:#111">:</span>
            <span style="color:#111">EOD</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">get_eod</span><span style="color:#111">(</span><span style="color:#111">tic</span><span style="color:#111">)</span>
        <span style="color:#00a8c8">except</span> <span style="color:#75af00">Exception</span><span style="color:#111">:</span>
            <span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">skip {tic} as it</span><span style="color:#8045ff">\&#39;</span><span style="color:#d88200">s missing in EOD dataset</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">with</span> <span style="color:#111">open</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">EOD.pkl</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">wb</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">f</span><span style="color:#111">:</span>
        <span style="color:#111">pickle</span><span style="color:#f92672">.</span><span style="color:#111">dump</span><span style="color:#111">(</span><span style="color:#111">EOD</span><span style="color:#111">,</span> <span style="color:#111">f</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Keep organizing data in order to make the merge of ZFB and EOD easier.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">ticker_update2</span> <span style="color:#f92672">=</span> <span style="color:#111">set</span><span style="color:#111">(</span><span style="color:#111">EOD</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">ticker_update</span>
<span style="color:#111">ZFB_update2</span> <span style="color:#f92672">=</span> <span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#111">(</span><span style="color:#111">ZFB</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ticker</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">isin</span><span style="color:#111">(</span><span style="color:#111">ticker_update2</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">]</span>
<span style="color:#111">ZFB_update3</span> <span style="color:#f92672">=</span> <span style="color:#111">ZFB_update2</span><span style="color:#111">[</span><span style="color:#111">ZFB_update2</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">tot_debt_tot_equity</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.1</span><span style="color:#111">]</span>
<span style="color:#111">ZFB_update3</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">final_debt</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">ZFB_update3</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">net_lterm_debt</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#111">ZFB_update3</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">tot_lterm_debt</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">ZFB_update3</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">final_debt</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">ZFB_update3</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">final_debt</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">ZFB_update3</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_end_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">to_datetime</span><span style="color:#111">(</span><span style="color:#111">ZFB_update3</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_end_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">ZFB_update3</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">filing_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">to_datetime</span><span style="color:#111">(</span><span style="color:#111">ZFB_update3</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">filing_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="calculate-financial-ratios">Calculate Financial Ratios</h4>
<p>We&rsquo;re going to use three different daily financial ratios to help us selcet tickers we&rsquo;re gonna use in our strategy. The three ratios are:</p>
<ul>
<li><strong>Debt to Market Cap</strong>: tot_debt_tot_equity * per_end_date_price / daily adjusted closing price</li>
<li><strong>Return on Investment</strong>: return_on_investment * (longterm_debt + market_value) / (longterm_debt + market_val * daily_adjusted_closing_price / per_end_date_price)</li>
<li><strong>Price to Earnings</strong>: daily_adjusted_closing_price / earnings_per_share</li>
</ul>
<p>We calcuate the three daily ratios based on their filing date and also the period end date for each company. Also, to prepare for the backtest, here we put the three ratios and also the daily return in the same dataframe.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">cols</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ticker</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_end_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">mkt_val</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">filing_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">eps_diluted_net</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span>
        <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">tot_debt_tot_equity</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ret_invst</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">final_debt</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
<span style="color:#111">ZFB_update4</span> <span style="color:#f92672">=</span> <span style="color:#111">ZFB_update3</span><span style="color:#111">[</span><span style="color:#111">cols</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">set_index</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ticker</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">available_tickers</span> <span style="color:#f92672">=</span> <span style="color:#111">set</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">for</span> <span style="color:#111">ticker</span> <span style="color:#f92672">in</span> <span style="color:#111">set</span><span style="color:#111">(</span><span style="color:#111">ZFB_update4</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#00a8c8">if</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Adj_Close</span><span style="color:#d88200">&#39;</span> <span style="color:#f92672">in</span> <span style="color:#111">EOD</span><span style="color:#111">[</span><span style="color:#111">ticker</span><span style="color:#111">]</span><span style="color:#111">:</span>
        <span style="color:#111">available_tickers</span><span style="color:#f92672">.</span><span style="color:#111">add</span><span style="color:#111">(</span><span style="color:#111">ticker</span><span style="color:#111">)</span>

<span style="color:#f92672">from</span> <span style="color:#111">functools</span> <span style="color:#f92672">import</span> <span style="color:#111">lru_cache</span>


<span style="color:#75af00">@lru_cache</span><span style="color:#111">(</span><span style="color:#111">maxsize</span><span style="color:#f92672">=</span><span style="color:#111">None</span><span style="color:#111">)</span>
<span style="color:#00a8c8">def</span> <span style="color:#75af00">prepare_data</span><span style="color:#111">(</span><span style="color:#111">ticker</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">ZFB_update4</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">ticker</span><span style="color:#111">]</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">isinstance</span><span style="color:#111">(</span><span style="color:#111">ret</span><span style="color:#111">,</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">Series</span><span style="color:#111">)</span><span style="color:#111">:</span> <span style="color:#00a8c8">return</span>
    <span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">set_index</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">per_end_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">join</span><span style="color:#111">(</span><span style="color:#111">EOD</span><span style="color:#111">[</span><span style="color:#111">ticker</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Adj_Close</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">how</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">outer</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
    <span style="color:#111">ret</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Adj_Close</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Adj_Close</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">ffill</span><span style="color:#111">(</span><span style="color:#111">)</span>
    <span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">subset</span><span style="color:#f92672">=</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">filing_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
    <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">list</span><span style="color:#111">(</span><span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">columns</span><span style="color:#111">[</span><span style="color:#111">:</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Adj_Close_bench</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
    <span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">reset_index</span><span style="color:#111">(</span><span style="color:#111">drop</span><span style="color:#f92672">=</span><span style="color:#111">True</span><span style="color:#111">)</span>
    <span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">set_index</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">filing_date</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
    <span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">EOD</span><span style="color:#111">[</span><span style="color:#111">ticker</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Adj_Close</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">join</span><span style="color:#111">(</span><span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">shift</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">how</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">left</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">ffill</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">ret</span>


<span style="color:#00a8c8">def</span> <span style="color:#75af00">calculate_ratios</span><span style="color:#111">(</span><span style="color:#111">ticker</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">data</span> <span style="color:#f92672">=</span> <span style="color:#111">prepare_data</span><span style="color:#111">(</span><span style="color:#111">ticker</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">data</span> <span style="color:#f92672">is</span> <span style="color:#111">None</span><span style="color:#111">:</span> <span style="color:#00a8c8">return</span>
    <span style="color:#00a8c8">if</span> <span style="color:#f92672">not</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#111">:</span> <span style="color:#00a8c8">return</span>
    <span style="color:#111">d2m</span> <span style="color:#f92672">=</span> <span style="color:#111">data</span><span style="color:#f92672">.</span><span style="color:#111">eval</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">tot_debt_tot_equity * Adj_Close_bench / Adj_Close</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
    <span style="color:#111">roi</span> <span style="color:#f92672">=</span> <span style="color:#111">data</span><span style="color:#f92672">.</span><span style="color:#111">eval</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ret_invst * (final_debt + mkt_val) / (final_debt + mkt_val * Adj_Close / Adj_Close_bench)</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
    <span style="color:#111">pe</span> <span style="color:#f92672">=</span> <span style="color:#111">data</span><span style="color:#f92672">.</span><span style="color:#111">eval</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Adj_Close / eps_diluted_net</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
    <span style="color:#111">px</span> <span style="color:#f92672">=</span> <span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Adj_Close</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
    <span style="color:#111">res</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">d2m</span><span style="color:#111">,</span> <span style="color:#111">roi</span><span style="color:#111">,</span> <span style="color:#111">pe</span><span style="color:#111">,</span> <span style="color:#111">px</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
    <span style="color:#111">res</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">d2m</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">roi</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pe</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">px</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">res</span>

<span style="color:#75715e"># calculate_ratios(&#39;LLY&#39;).loc[&#39;2017-10-27&#39;]</span>

<span style="color:#00a8c8">if</span> <span style="color:#111">os</span><span style="color:#f92672">.</span><span style="color:#111">path</span><span style="color:#f92672">.</span><span style="color:#111">isfile</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">RATIOS.pkl</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#00a8c8">with</span> <span style="color:#111">open</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">RATIOS.pkl</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">rb</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">f</span><span style="color:#111">:</span>
        <span style="color:#111">RATIOS</span> <span style="color:#f92672">=</span> <span style="color:#111">pickle</span><span style="color:#f92672">.</span><span style="color:#111">load</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#111">)</span>
<span style="color:#00a8c8">else</span><span style="color:#111">:</span>
    <span style="color:#111">RATIOS</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span><span style="color:#111">}</span>
    <span style="color:#00a8c8">for</span> <span style="color:#111">ticker</span> <span style="color:#f92672">in</span> <span style="color:#111">tqdm</span><span style="color:#111">(</span><span style="color:#111">available_tickers</span><span style="color:#111">)</span><span style="color:#111">:</span>
        <span style="color:#111">ratios</span> <span style="color:#f92672">=</span> <span style="color:#111">calculate_ratios</span><span style="color:#111">(</span><span style="color:#111">ticker</span><span style="color:#111">)</span>
        <span style="color:#00a8c8">if</span> <span style="color:#111">ratios</span> <span style="color:#f92672">is</span> <span style="color:#111">None</span><span style="color:#111">:</span>
            <span style="color:#00a8c8">continue</span>
        <span style="color:#00a8c8">else</span><span style="color:#111">:</span>
            <span style="color:#111">RATIOS</span><span style="color:#111">[</span><span style="color:#111">ticker</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">ratios</span>
    <span style="color:#00a8c8">with</span> <span style="color:#111">open</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">RATIOS.pkl</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">wb</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">f</span><span style="color:#111">:</span>
        <span style="color:#111">pickle</span><span style="color:#f92672">.</span><span style="color:#111">dump</span><span style="color:#111">(</span><span style="color:#111">RATIOS</span><span style="color:#111">,</span> <span style="color:#111">f</span><span style="color:#111">)</span>

<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">{len(RATIOS)} tickers in total</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>1723 tickers in total
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">STRATEGY_DATA</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span><span style="color:#111">k</span><span style="color:#111">:</span> <span style="color:#111">v</span><span style="color:#f92672">.</span><span style="color:#111">resample</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">M</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">last</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">pct_change</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">k</span><span style="color:#111">,</span> <span style="color:#111">v</span> <span style="color:#f92672">in</span> <span style="color:#111">RATIOS</span><span style="color:#f92672">.</span><span style="color:#111">items</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="2-backtest">2. Backtest</h2>
<p>In this section, we perform the backtest for this strategy. We seperately consider each of the financial ratios we calculated earlier as the index in order to rank the performance of the companies in our portfolio. By using the rop-and-bottom strategy , we dynamically take a long position in the top 10 percentile of all companies&rsquo; stocks and a short position in the bottom 10 percentile.</p>
<p>Although we&rsquo;re assuming that there&rsquo;s no trading costs here and all securities are easy to borrow, since in the real world these fees are all gonna be the costs of our strategy, I decide to change my position every month in order to simulate the real world as close as possible.</p>
<p>Also, we introduce three indexes to help us find if the strategy is good, they&rsquo;re:</p>
<ul>
<li>Sharpe Ratio: return of an investment compared to its risk</li>
<li>Maximnm Drawdown: maximum observed loss from a peak to a trough</li>
<li>Winning Rate: the percentage of winning</li>
</ul>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">def</span> <span style="color:#75af00">sharpe</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">std</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0.5</span> <span style="color:#00a8c8">if</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">std</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">else</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">nan</span><span style="color:#111">)</span>

<span style="color:#00a8c8">def</span> <span style="color:#75af00">win_rate</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">sum</span><span style="color:#111">(</span><span style="color:#111">x</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#111">sum</span><span style="color:#111">(</span><span style="color:#111">x</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#00a8c8">if</span> <span style="color:#111">any</span><span style="color:#111">(</span><span style="color:#111">x</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#00a8c8">else</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">nan</span><span style="color:#111">)</span>

<span style="color:#00a8c8">def</span> <span style="color:#75af00">maximum_drawdown</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">:</span>  <span style="color:#75715e"># use absolute drawdown instead of percentage here -&gt; cum pnl could be negative</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">cummax</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">max</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Following are the three seperate backtests for each of the financial ratio.</p>
<h3 id="debt_to_market_ratio">Debt_to_market_ratio</h3>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">debt_to_market_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">STRATEGY_DATA</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">d2m</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">debt_to_market_table</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#f92672">.</span><span style="color:#111">keys</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">debt_to_market_table_temp</span> <span style="color:#f92672">=</span> <span style="color:#111">debt_to_market_table</span><span style="color:#f92672">.</span><span style="color:#111">T</span>

<span style="color:#111">n</span> <span style="color:#f92672">=</span> <span style="color:#111">round</span><span style="color:#111">(</span><span style="color:#ae81ff">1723</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span><span style="color:#111">)</span>  <span style="color:#75715e"># number of tickers we&#39;re gonna use in the strategy</span>

<span style="color:#111">returns_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">STRATEGY_DATA</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">px</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#f92672">.</span><span style="color:#111">keys</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">debt_to_market_strategy</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">(</span>
    <span style="color:#111">[</span><span style="color:#111">debt_to_market_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nlargest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">+</span>
     <span style="color:#111">debt_to_market_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nsmallest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">debt_to_market_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">]</span><span style="color:#111">,</span>
    <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">debt_to_market_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">shift</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">coef</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">array</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span> <span style="color:#f92672">+</span> <span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span><span style="color:#111">)</span>

<span style="color:#111">debt_to_market_return</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">Series</span><span style="color:#111">(</span><span style="color:#111">[</span>
    <span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">,</span> <span style="color:#111">debt_to_market_strategy</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">values</span><span style="color:#111">]</span> <span style="color:#960050;background-color:#1e0010">@</span> <span style="color:#111">coef</span>
    <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">debt_to_market_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span>
<span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">debt_to_market_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">figure</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">debt_to_market_return</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Monthly PNL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/financial_quantile/output_26_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">sharpe={sharpe(debt_to_market_return):.2f}, win</span><span style="color:#d88200">%</span><span style="color:#d88200">={win_rate(debt_to_market_return):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}, mdd={maximum_drawdown(debt_to_market_return):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>sharpe=0.03, win%=33.77%, mdd=7.43%
</code></pre>
<h3 id="return-on-investment">Return on Investment</h3>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">return_on_investment_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">STRATEGY_DATA</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">roi</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">return_on_investment_table</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#f92672">.</span><span style="color:#111">keys</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">return_on_investment_table_temp</span> <span style="color:#f92672">=</span> <span style="color:#111">return_on_investment_table</span><span style="color:#f92672">.</span><span style="color:#111">T</span>

<span style="color:#111">n</span> <span style="color:#f92672">=</span> <span style="color:#111">round</span><span style="color:#111">(</span><span style="color:#ae81ff">1723</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span><span style="color:#111">)</span>  <span style="color:#75715e"># number of tickers we&#39;re gonna use in the strategy</span>

<span style="color:#111">returns_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">STRATEGY_DATA</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">px</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#f92672">.</span><span style="color:#111">keys</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">return_on_investment_strategy</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">(</span>
    <span style="color:#111">[</span><span style="color:#111">return_on_investment_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nlargest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">+</span>
     <span style="color:#111">return_on_investment_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nsmallest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">return_on_investment_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">]</span><span style="color:#111">,</span>
    <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">return_on_investment_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">shift</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">coef</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">array</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span> <span style="color:#f92672">+</span> <span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span><span style="color:#111">)</span>

<span style="color:#111">return_on_investment_return</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">Series</span><span style="color:#111">(</span><span style="color:#111">[</span>
    <span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">,</span> <span style="color:#111">return_on_investment_strategy</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">values</span><span style="color:#111">]</span> <span style="color:#960050;background-color:#1e0010">@</span> <span style="color:#111">coef</span>
    <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">return_on_investment_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span>
<span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">return_on_investment_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">figure</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">return_on_investment_return</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Monthly PNL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/financial_quantile/output_29_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">sharpe={sharpe(return_on_investment_return):.2f}, win</span><span style="color:#d88200">%</span><span style="color:#d88200">={win_rate(return_on_investment_return):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}, mdd={maximum_drawdown(return_on_investment_return):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>sharpe=0.10, win%=40.26%, mdd=5.80%
</code></pre>
<h3 id="price-to-earnings">Price to Earnings</h3>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">price_to_earnings_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">STRATEGY_DATA</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pe</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">price_to_earnings_table</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#f92672">.</span><span style="color:#111">keys</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">price_to_earnings_table_temp</span> <span style="color:#f92672">=</span> <span style="color:#111">price_to_earnings_table</span><span style="color:#f92672">.</span><span style="color:#111">T</span>

<span style="color:#111">n</span> <span style="color:#f92672">=</span> <span style="color:#111">round</span><span style="color:#111">(</span><span style="color:#ae81ff">1723</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span><span style="color:#111">)</span>  <span style="color:#75715e"># number of tickers we&#39;re gonna use in the strategy</span>

<span style="color:#111">returns_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">STRATEGY_DATA</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">px</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#f92672">.</span><span style="color:#111">keys</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">price_to_earnings_strategy</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">(</span>
    <span style="color:#111">[</span><span style="color:#111">price_to_earnings_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nlargest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">+</span>
     <span style="color:#111">price_to_earnings_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nsmallest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">price_to_earnings_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">]</span><span style="color:#111">,</span>
    <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">price_to_earnings_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">shift</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">coef</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">array</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span> <span style="color:#f92672">+</span> <span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span><span style="color:#111">)</span>

<span style="color:#111">price_to_earnings_return</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">Series</span><span style="color:#111">(</span><span style="color:#111">[</span>
    <span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">,</span> <span style="color:#111">price_to_earnings_strategy</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">values</span><span style="color:#111">]</span> <span style="color:#960050;background-color:#1e0010">@</span> <span style="color:#111">coef</span>
    <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">price_to_earnings_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span>
<span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">price_to_earnings_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">figure</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">price_to_earnings_return</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Monthly PNL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/financial_quantile/output_32_0.png" alt="picture alt"></p>
<p>Here, from the plot of cumulative return of the strategy, we could find that the return is negative all the time. Reasonably, we could guess that maybe the correlation between the PE ratio and our monthly returns are negative so that our position here is wrong.</p>
<p>So, we could use a regression to analyze this special case here.\</p>
<p>First, we organize the three ratios and also the returns in one dataframe for the convenience of the regression</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">def</span> <span style="color:#75af00">add_return</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">x</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">return</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">x</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">px</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">shift</span><span style="color:#111">(</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">x</span>

<span style="color:#111">STRATEGY_DATA_update</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span><span style="color:#111">k</span><span style="color:#111">:</span> <span style="color:#111">add_return</span><span style="color:#111">(</span><span style="color:#111">v</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">k</span><span style="color:#111">,</span> <span style="color:#111">v</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#f92672">.</span><span style="color:#111">items</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">}</span>

<span style="color:#111">regression_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">df</span><span style="color:#111">[</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">return</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">d2m</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">roi</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pe</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">df</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA_update</span><span style="color:#f92672">.</span><span style="color:#111">values</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">regression_table</span> <span style="color:#f92672">=</span> <span style="color:#111">regression_table</span><span style="color:#111">[</span><span style="color:#111">(</span><span style="color:#111">abs</span><span style="color:#111">(</span><span style="color:#111">regression_table</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1e6</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">all</span><span style="color:#111">(</span><span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#111">]</span>
<span style="color:#111">regression_table</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ret</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">d2m</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">roi</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pe</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
<span style="color:#111">regression_table</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>time</th>
<th>ret</th>
<th>d2m</th>
<th>roi</th>
<th>pe</th>
</tr>
</thead>
<tbody>
<tr>
<td>2015-10-31</td>
<td>-0.208361</td>
<td>-0.190541</td>
<td>-0.173861</td>
<td>0.235393</td>
</tr>
<tr>
<td>2015-11-30</td>
<td>0.235393</td>
<td>-0.129454</td>
<td>-0.119475</td>
<td>0.148704</td>
</tr>
<tr>
<td>2015-12-31</td>
<td>0.148704</td>
<td>0.032284</td>
<td>0.029722</td>
<td>-0.031275</td>
</tr>
<tr>
<td>2016-01-31</td>
<td>-0.031275</td>
<td>0.184988</td>
<td>0.167840</td>
<td>-0.156110</td>
</tr>
<tr>
<td>2016-02-29</td>
<td>-0.156110</td>
<td>-0.173669</td>
<td>-0.160149</td>
<td>0.210169</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
<tr>
<td>2017-05-31</td>
<td>0.028055</td>
<td>0.060240</td>
<td>1.312317</td>
<td>-0.527728</td>
</tr>
<tr>
<td>2017-06-30</td>
<td>-0.032418</td>
<td>-0.110905</td>
<td>-0.114231</td>
<td>0.124740</td>
</tr>
<tr>
<td>2017-07-31</td>
<td>0.124740</td>
<td>0.042822</td>
<td>0.044163</td>
<td>-0.041064</td>
</tr>
<tr>
<td>2017-08-31</td>
<td>-0.041064</td>
<td>-0.125853</td>
<td>-0.686000</td>
<td>1.827308</td>
</tr>
<tr>
<td>2017-09-30</td>
<td>-0.057564</td>
<td>-0.126829</td>
<td>-0.139936</td>
<td>0.145251</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">result_regression</span> <span style="color:#f92672">=</span> <span style="color:#111">smf</span><span style="color:#f92672">.</span><span style="color:#111">ols</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ret ~ pe + 0</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">data</span><span style="color:#f92672">=</span><span style="color:#111">regression_table</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">fit</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">result_regression</span><span style="color:#f92672">.</span><span style="color:#111">summary</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>                                 OLS Regression Results                                
=======================================================================================
Dep. Variable:                    ret   R-squared (uncentered):                   0.000
Model:                            OLS   Adj. R-squared (uncentered):              0.000
Method:                 Least Squares   F-statistic:                              5.982
Date:                Sat, 09 May 2020   Prob (F-statistic):                      0.0145
Time:                        10:04:11   Log-Likelihood:                          18935.
No. Observations:              106213   AIC:                                 -3.787e+04
Df Residuals:                  106212   BIC:                                 -3.786e+04
Df Model:                           1                                                  
Covariance Type:            nonrobust                                                  
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
pe             0.0001    4.6e-05      2.446      0.014    2.23e-05       0.000
==============================================================================
Omnibus:                   394481.026   Durbin-Watson:                   2.025
Prob(Omnibus):                  0.000   Jarque-Bera (JB):     683351033378.908
Skew:                          80.866   Prob(JB):                         0.00
Kurtosis:                   12428.158   Cond. No.                         1.00
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</code></pre>
<p>From the regression result, we could see that their correlation is nearly 0. So we try to change the original position of the strategy to opposite, which is to long the bottom stock and short the top stock.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">price_to_earnings_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">STRATEGY_DATA</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pe</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">price_to_earnings_table</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#f92672">.</span><span style="color:#111">keys</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">price_to_earnings_table_temp</span> <span style="color:#f92672">=</span> <span style="color:#111">price_to_earnings_table</span><span style="color:#f92672">.</span><span style="color:#111">T</span>

<span style="color:#111">n</span> <span style="color:#f92672">=</span> <span style="color:#111">round</span><span style="color:#111">(</span><span style="color:#ae81ff">1723</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span><span style="color:#111">)</span>  <span style="color:#75715e"># number of tickers we&#39;re gonna use in the strategy</span>

<span style="color:#111">returns_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">STRATEGY_DATA</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">px</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#f92672">.</span><span style="color:#111">keys</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">price_to_earnings_strategy</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">(</span>
    <span style="color:#111">[</span><span style="color:#111">price_to_earnings_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nlargest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">+</span>
     <span style="color:#111">price_to_earnings_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nsmallest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">price_to_earnings_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">]</span><span style="color:#111">,</span>
    <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">price_to_earnings_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">shift</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">coef</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">array</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span> <span style="color:#f92672">+</span> <span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span><span style="color:#111">)</span>

<span style="color:#111">price_to_earnings_return</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">Series</span><span style="color:#111">(</span><span style="color:#111">[</span>
    <span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">,</span> <span style="color:#111">price_to_earnings_strategy</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">values</span><span style="color:#111">]</span> <span style="color:#960050;background-color:#1e0010">@</span> <span style="color:#111">coef</span>
    <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">price_to_earnings_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span>
<span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">price_to_earnings_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">figure</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">price_to_earnings_return</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Monthly PNL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/financial_quantile/output_37_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">sharpe={sharpe(price_to_earnings_return):.2f}, win</span><span style="color:#d88200">%</span><span style="color:#d88200">={win_rate(price_to_earnings_return):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}, mdd={maximum_drawdown(price_to_earnings_return):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>sharpe=0.04, win%=42.86%, mdd=7.09%
</code></pre>
<p>It seems like the fix way of changing position works here.</p>
<p>If we use two indexes such as debt_to_market ratio and return on investment, the strategy is different from above. We should firstly take the regression of monthly returns and the combination of the two indexes in order to analyze the relationship between them. Once the correlation is fixed, we could use the regression to predict the return and then use the predicted return as our new index to rank the companies. Once the ranking is set, we could then use the signal to compute our top-and-bottom strategy.</p>
<h3 id="multiple-indexes">Multiple indexes</h3>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">debt_to_mkt_roi_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">df</span><span style="color:#111">[</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">return</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">d2m</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">roi</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">df</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA_update</span><span style="color:#f92672">.</span><span style="color:#111">values</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">debt_to_mkt_roi_table</span> <span style="color:#f92672">=</span> <span style="color:#111">debt_to_mkt_roi_table</span><span style="color:#111">[</span><span style="color:#111">(</span><span style="color:#111">abs</span><span style="color:#111">(</span><span style="color:#111">debt_to_mkt_roi_table</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1e6</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">all</span><span style="color:#111">(</span><span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#111">]</span>
<span style="color:#111">debt_to_mkt_roi_table</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>time</th>
<th>return</th>
<th>d2m</th>
<th>roi</th>
</tr>
</thead>
<tbody>
<tr>
<td>2015-10-31</td>
<td>-0.208361</td>
<td>-0.190541</td>
<td>-0.173861</td>
</tr>
<tr>
<td>2015-11-30</td>
<td>0.235393</td>
<td>-0.129454</td>
<td>-0.119475</td>
</tr>
<tr>
<td>2015-12-31</td>
<td>0.148704</td>
<td>0.032284</td>
<td>0.029722</td>
</tr>
<tr>
<td>2016-01-31</td>
<td>-0.031275</td>
<td>0.184988</td>
<td>0.167840</td>
</tr>
<tr>
<td>2016-02-29</td>
<td>-0.156110</td>
<td>-0.173669</td>
<td>-0.160149</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
<tr>
<td>2017-05-31</td>
<td>0.028055</td>
<td>0.060240</td>
<td>1.312317</td>
</tr>
<tr>
<td>2017-06-30</td>
<td>-0.032418</td>
<td>-0.110905</td>
<td>-0.114231</td>
</tr>
<tr>
<td>2017-07-31</td>
<td>0.124740</td>
<td>0.042822</td>
<td>0.044163</td>
</tr>
<tr>
<td>2017-08-31</td>
<td>-0.041064</td>
<td>-0.125853</td>
<td>-0.686000</td>
</tr>
<tr>
<td>2017-09-30</td>
<td>-0.057564</td>
<td>-0.126829</td>
<td>-0.139936</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">result</span> <span style="color:#f92672">=</span> <span style="color:#111">smf</span><span style="color:#f92672">.</span><span style="color:#111">ols</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ret ~ d2m + roi + 0</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">data</span><span style="color:#f92672">=</span><span style="color:#111">debt_to_mkt_roi_table</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">fit</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">result</span><span style="color:#f92672">.</span><span style="color:#111">summary</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>                                 OLS Regression Results                                
=======================================================================================
Dep. Variable:                    ret   R-squared (uncentered):                   0.000
Model:                            OLS   Adj. R-squared (uncentered):             -0.000
Method:                 Least Squares   F-statistic:                             0.2486
Date:                Sat, 09 May 2020   Prob (F-statistic):                       0.780
Time:                        03:57:33   Log-Likelihood:                          18932.
No. Observations:              106213   AIC:                                 -3.786e+04
Df Residuals:                  106211   BIC:                                 -3.784e+04
Df Model:                           2                                                  
Covariance Type:            nonrobust                                                  
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
d2m         6.845e-08   1.99e-05      0.003      0.997   -3.89e-05     3.9e-05
roi         1.401e-05   1.99e-05      0.705      0.481   -2.49e-05     5.3e-05
==============================================================================
Omnibus:                   394471.204   Durbin-Watson:                   2.024
Prob(Omnibus):                  0.000   Jarque-Bera (JB):     683212647084.185
Skew:                          80.860   Prob(JB):                         0.00
Kurtosis:                   12426.900   Cond. No.                         1.00
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</code></pre>
<p>Here, after getting the result of the regression, we could use the model to predict the returns.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">coeffient</span> <span style="color:#f92672">=</span> <span style="color:#111">result</span><span style="color:#f92672">.</span><span style="color:#111">params</span>
<span style="color:#111">ret_hat</span> <span style="color:#f92672">=</span> <span style="color:#111">debt_to_mkt_roi_table</span><span style="color:#111">[</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">d2m</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">roi</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">]</span> <span style="color:#960050;background-color:#1e0010">@</span> <span style="color:#111">coeffient</span>
<span style="color:#111">prediction</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">ret_hat</span><span style="color:#111">,</span> <span style="color:#111">debt_to_mkt_roi_table</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ret</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">prediction</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ret_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ret</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>d2m    6.845391e-08
roi    1.401465e-05
dtype: float64
</code></pre>
<p>We could draw the scatter plot of return and predicted return to figure out if the prediction is reasonable. From the plot below, we could find out that the prediction is pretty decent(though the R-square is almost 0 in the model).</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ret_hat.plot.scatter(x=&#39;ret_hat&#39;, y=&#39;ret&#39;, data=prediction);</span>

<span style="color:#111">fig</span> <span style="color:#f92672">=</span> <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">figure</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">ax</span> <span style="color:#f92672">=</span> <span style="color:#111">fig</span><span style="color:#f92672">.</span><span style="color:#111">add_subplot</span><span style="color:#111">(</span><span style="color:#ae81ff">111</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">scatter</span><span style="color:#111">(</span><span style="color:#111">prediction</span><span style="color:#f92672">.</span><span style="color:#111">ret_hat</span><span style="color:#111">,</span> <span style="color:#111">prediction</span><span style="color:#f92672">.</span><span style="color:#111">ret</span><span style="color:#111">,</span> <span style="color:#111">s</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">k</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#75715e"># Fmin_ETH_USD = train_ETH_USD.F.min()</span>
<span style="color:#75715e"># Fmax_ETH_USD = train_ETH_USD.F.max()</span>
<span style="color:#75715e"># ax.plot((Fmin_ETH_USD, Fmax_ETH_USD), (Fmin_ETH_USD * beta_ETH_USD, Fmax_ETH_USD * beta_ETH_USD), c=&#39;r&#39;)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xlabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ret_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ret</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#75715e"># plt.xlim(Fmin_ETH_USD, Fmax_ETH_USD)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/financial_quantile/output_46_0.png" alt="picture alt"></p>
<p>Compute the strategy.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">multi_ratio_table</span> <span style="color:#f92672">=</span> <span style="color:#111">coeffient</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">d2m</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">debt_to_market_table</span> <span style="color:#f92672">+</span> <span style="color:#111">coeffient</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">roi</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">return_on_investment_table</span>
<span style="color:#111">multi_ratio_table_temp</span> <span style="color:#f92672">=</span> <span style="color:#111">multi_ratio_table</span><span style="color:#f92672">.</span><span style="color:#111">T</span>


<span style="color:#111">n</span> <span style="color:#f92672">=</span> <span style="color:#111">round</span><span style="color:#111">(</span><span style="color:#ae81ff">1723</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span><span style="color:#111">)</span>  <span style="color:#75715e"># number of tickers we&#39;re gonna use in the strategy</span>

<span style="color:#111">returns_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">STRATEGY_DATA</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">px</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#f92672">.</span><span style="color:#111">keys</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">multi_ratio_strategy</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">(</span>
    <span style="color:#111">[</span><span style="color:#111">multi_ratio_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nlargest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">+</span>
     <span style="color:#111">multi_ratio_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nsmallest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">multi_ratio_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">]</span><span style="color:#111">,</span>
    <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">multi_ratio_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">shift</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">coef</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">array</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span> <span style="color:#f92672">+</span> <span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#111">n</span><span style="color:#111">)</span>

<span style="color:#111">multi_ratio_return</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">Series</span><span style="color:#111">(</span><span style="color:#111">[</span>
    <span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">,</span> <span style="color:#111">multi_ratio_strategy</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">values</span><span style="color:#111">]</span> <span style="color:#960050;background-color:#1e0010">@</span> <span style="color:#111">coef</span>
    <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">multi_ratio_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span>
<span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">multi_ratio_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">figure</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">multi_ratio_return</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Monthly PNL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/financial_quantile/output_48_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">sharpe={sharpe(multi_ratio_return):.2f}, win</span><span style="color:#d88200">%</span><span style="color:#d88200">={win_rate(multi_ratio_return):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}, mdd={maximum_drawdown(multi_ratio_return):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>sharpe=0.10, win%=40.26%, mdd=5.80%
</code></pre>
<p>From the result above and the comparison between using one ratio and two ratios, we could find out that by using two ratios, the performance of the strategy is better.</p>
<h2 id="3-discussion-about-sizing">3. Discussion about Sizing</h2>
<p>The concept of sizing position by rank is that, instead of equally longing the top-10 percentile of the portoflio and equally going short the bottom-10 percentile of the portfolio, we could try to implenment the idea of &ldquo;better performence, higher weight&rdquo; in the strategy, which means that if the performance of the portfolio is ranked, we could give more weight to the higher ranked portfolio in order to better our performance.</p>
<p>Following, I tried to implement this idea into the multi-index strategy I talked before.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">multi_ratio_table</span> <span style="color:#f92672">=</span> <span style="color:#111">coeffient</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">d2m</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">debt_to_market_table</span> <span style="color:#f92672">+</span> <span style="color:#111">coeffient</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">roi</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">return_on_investment_table</span>
<span style="color:#111">multi_ratio_table_temp</span> <span style="color:#f92672">=</span> <span style="color:#111">multi_ratio_table</span><span style="color:#f92672">.</span><span style="color:#111">T</span>


<span style="color:#111">n</span> <span style="color:#f92672">=</span> <span style="color:#111">round</span><span style="color:#111">(</span><span style="color:#ae81ff">1723</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span><span style="color:#111">)</span>  <span style="color:#75715e"># number of tickers we&#39;re gonna use in the strategy</span>
<span style="color:#111">n</span> <span style="color:#f92672">-</span><span style="color:#f92672">=</span> <span style="color:#111">n</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span>

<span style="color:#111">returns_table</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">STRATEGY_DATA</span><span style="color:#111">[</span><span style="color:#111">tic</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">px</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">tic</span> <span style="color:#f92672">in</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">STRATEGY_DATA</span><span style="color:#f92672">.</span><span style="color:#111">keys</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">multi_ratio_strategy</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">(</span>
    <span style="color:#111">[</span><span style="color:#111">multi_ratio_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nlargest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">+</span>
     <span style="color:#111">multi_ratio_table_temp</span><span style="color:#f92672">.</span><span style="color:#111">nsmallest</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">multi_ratio_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">]</span><span style="color:#111">,</span>
    <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">multi_ratio_table</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">shift</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">)</span>


<span style="color:#111">coef</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">array</span><span style="color:#111">(</span><span style="color:#111">list</span><span style="color:#111">(</span><span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">arange</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#111">list</span><span style="color:#111">(</span><span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">arange</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#111">n</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">coef</span> <span style="color:#f92672">=</span> <span style="color:#111">coef</span> <span style="color:#f92672">/</span> <span style="color:#111">abs</span><span style="color:#111">(</span><span style="color:#111">coef</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">sum</span><span style="color:#111">(</span><span style="color:#111">)</span>


<span style="color:#111">multi_ratio_return</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">Series</span><span style="color:#111">(</span><span style="color:#111">[</span>
    <span style="color:#111">returns_table</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">,</span> <span style="color:#111">multi_ratio_strategy</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">values</span><span style="color:#111">]</span> <span style="color:#960050;background-color:#1e0010">@</span> <span style="color:#111">coef</span>
    <span style="color:#00a8c8">for</span> <span style="color:#111">t</span> <span style="color:#f92672">in</span> <span style="color:#111">multi_ratio_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span>
<span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">multi_ratio_strategy</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">figure</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">multi_ratio_return</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Monthly PNL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/financial_quantile/output_52_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">sharpe={sharpe(multi_ratio_return):.2f}, win</span><span style="color:#d88200">%</span><span style="color:#d88200">={win_rate(multi_ratio_return):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}, mdd={maximum_drawdown(multi_ratio_return):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>sharpe=0.08, win%=38.96%, mdd=6.39%
</code></pre>
<p>Not as expected, the adjusted return is actually not better than the strategy we used before. I think the intuition of this idea is reasonable, but maybe the sample size of this strategy is too small, which could not represent the overall performance of this idea. What&rsquo;s more, I just used arange() to pick the position size of this strategy, I believe there&rsquo;re more reasonable sizing ways to improve the performance of this idea. Also, different combination of different indexes have different performances. Those are things we could work on in the future.</p>
<h2 id="4-conclusion">4. Conclusion</h2>
<p>In this strategy, we discussed Quantile trading using different ratios. We could find out although we&rsquo;re making profits, the performance of the strategy is not that ideal. There&rsquo;re several ways that may improve the performance of the strategy. Since we used monthly quantile trading, changing the frequency may be a way of improvement. However, in the real world, we should be careful because there&rsquo;s no free lunch in the real market and every transaction has its costs and risks. Higher frequency may be more sensitive, but we should also consider the costs there. Also, like I said above, by finding the optimized size of different positions, we potentially could also improve the performance of our strategy.</p>

      </div>


      <footer>
        


        
        
        <script src="https://utteranc.es/client.js"
  repo= "christineeeeee/christineeeeee.github.io"
  issue-term="pathname"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script>
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
    
    
    
  </section>

</footer>

    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-171417581-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  </body>

</html>
