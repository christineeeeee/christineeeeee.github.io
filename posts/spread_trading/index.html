<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Christine">
    
    

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spread Trading Strategy"/>
<meta name="twitter:description" content="This is a spreading strategy which is based on M-day returns of two highly related futures. The idea of this strategy is to hedge the risk of buying and holding one specific future with increasing returns by holding the opposite position of another future.
We define g and j be our trading thresholds in this strategy. Besides, we also have stop-loss threshold s. Our initial capital K is $100MM.
1. Introduction In this section we give brief intro on the strategy we&rsquo;re about to implement."/>

    <meta property="og:title" content="Spread Trading Strategy" />
<meta property="og:description" content="This is a spreading strategy which is based on M-day returns of two highly related futures. The idea of this strategy is to hedge the risk of buying and holding one specific future with increasing returns by holding the opposite position of another future.
We define g and j be our trading thresholds in this strategy. Besides, we also have stop-loss threshold s. Our initial capital K is $100MM.
1. Introduction In this section we give brief intro on the strategy we&rsquo;re about to implement." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://christineeeeee.com/posts/spread_trading/" />
<meta property="article:published_time" content="2020-03-17T22:16:00+00:00" />
<meta property="article:modified_time" content="2020-03-17T22:16:00+00:00" />


    
      <base href="https://christineeeeee.com/posts/spread_trading/">
    
    <title>
  Spread Trading Strategy · Stop this train
</title>

    
      <link rel="canonical" href="https://christineeeeee.com/posts/spread_trading/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.c6a6f7e4e5b9eae62968f9dee6cad8903a7a12c11df9305249ee05c53679cafe.css" integrity="sha256-xqb35OW56uYpaPne5srYkDp6EsEd&#43;TBSSe4FxTZ5yv4=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="/css/custom.css" />
    

    

    

    <link rel="icon" type="image/png" href="https://christineeeeee.com/images/avatar.jpg" sizes="32x32">
    <link rel="icon" type="image/png" href="https://christineeeeee.com/images/avatar.jpg" sizes="16x16">

    <meta name="generator" content="Hugo 0.63.1" />
  </head>

  
  
  <body class="colorscheme-light">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      Stop this train
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://christineeeeee.com/posts/">Posts</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://christineeeeee.com/pieces/">Pieces</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://christineeeeee.com/newsletter/">Newsletter</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://christineeeeee.com/about/">About</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Spread Trading Strategy</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-03-17T22:16:00Z'>
                March 17, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              17-minute read
            </span>
          </div>
          
          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="/tags/python/">Python</a>
      <span class="separator">•</span>
    <a href="/tags/strategy/">Strategy</a></div>

        </div>
      </header>

      <div>
        
        <p>This is a spreading strategy which is based on M-day returns of two highly related futures. The idea of this strategy is to hedge the risk of buying and holding one specific future with increasing returns by holding the opposite position of another future.</p>
<p>We define g and j be our trading thresholds in this strategy. Besides, we also have stop-loss threshold s. Our initial capital K is $100MM.</p>
<h2 id="1-introduction">1. Introduction</h2>
<p>In this section we give brief intro on the strategy we&rsquo;re about to implement.</p>
<h3 id="the-rule-of-spread-strategy">The rule of spread strategy</h3>
<p>After confirming our pair of futures, when market opnes, we enter the market and observe our current position:</p>
<ul>
<li>
<p><strong>If we&rsquo;re currently not trading:</strong>
we observe our strategy spread, if the -g &lt; r &lt; g, we do nothing today; if r &gt; g, we go short our spread today; if r &lt; g, we go long our spread.</p>
</li>
<li>
<p><strong>If we&rsquo;re currently longing in spread:</strong>
we ovserve our strategy spread, if r &lt; -j, we do nothing today; if r &gt; g, we go short our spread today; if -j &lt; r &lt; g, we close our position.</p>
</li>
<li>
<p><strong>If we&rsquo;re currently going short in spread:</strong>
we ovserve our strategy spread, if r &gt; j, we do nothing today; if r &lt; -g, we go short our spread today; if -g &lt; r &lt; j, we close our position.</p>
</li>
</ul>
<p>Besides the observation of our spread and thresholds, we also should keep an eye on the stop-loss threshold. If the strategy losts certain percentage of our capital, the stop-loss shreshold will be triggered and our positoin will be closed for the rest of the month.</p>
<p>What&rsquo;s more, every last day of each month, our position will be closed once.</p>
<h2 id="2-data-preparation">2. Data Preparation</h2>
<h3 id="introduction-of-the-packages-in-spread-trading">Introduction of the packages in spread trading</h3>
<p>We&rsquo;re using several really important python pac</p>
<ul>
<li><strong>Pandas</strong>: dataframe manipulation</li>
<li><strong>NumPy</strong>: support for mathematical functions and computation of arrays and matrics</li>
<li><strong>Statsmodel</strong>: statistical analysis</li>
<li><strong>Matplotlib</strong>: plot tools</li>
<li><strong>Seaborn</strong>: statistical data visualization</li>
<li><strong>Scipy</strong>: statistical analysis</li>
<li><strong>tqdm</strong>: progress bar</li>
<li><strong>itertools</strong>: produce grid of parameters</li>
</ul>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> <span style="color:#111">quandl</span>
<span style="color:#f92672">import</span> <span style="color:#111">pandas</span> <span style="color:#f92672">as</span> <span style="color:#111">pd</span>
<span style="color:#f92672">import</span> <span style="color:#111">numpy</span> <span style="color:#f92672">as</span> <span style="color:#111">np</span>
<span style="color:#f92672">import</span> <span style="color:#111">warnings</span>
<span style="color:#f92672">import</span> <span style="color:#111">statsmodels.api</span> <span style="color:#f92672">as</span> <span style="color:#111">sm</span>
<span style="color:#f92672">import</span> <span style="color:#111">statsmodels.formula.api</span> <span style="color:#f92672">as</span> <span style="color:#111">smf</span>
<span style="color:#f92672">import</span> <span style="color:#111">matplotlib.pyplot</span> <span style="color:#f92672">as</span> <span style="color:#111">plt</span>
<span style="color:#f92672">import</span> <span style="color:#111">seaborn</span> <span style="color:#f92672">as</span> <span style="color:#111">sns</span>
<span style="color:#f92672">from</span> <span style="color:#111">tqdm.auto</span> <span style="color:#f92672">import</span> <span style="color:#111">tqdm</span>
<span style="color:#f92672">from</span> <span style="color:#111">scipy</span> <span style="color:#f92672">import</span> <span style="color:#111">stats</span>
<span style="color:#f92672">from</span> <span style="color:#111">itertools</span> <span style="color:#f92672">import</span> <span style="color:#111">product</span>
<span style="color:#f92672">from</span> <span style="color:#111">statsmodels.tsa.stattools</span> <span style="color:#f92672">import</span> <span style="color:#111">adfuller</span>
<span style="color:#f92672">from</span> <span style="color:#111">statsmodels.graphics.tsaplots</span> <span style="color:#f92672">import</span> <span style="color:#111">plot_acf</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">warnings</span><span style="color:#f92672">.</span><span style="color:#111">filterwarnings</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ignore</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">set_option</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">max_rows</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">100</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">rcParams</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">figure.figsize</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#ae81ff">4</span><span style="color:#111">)</span>

<span style="color:#111">quandl</span><span style="color:#f92672">.</span><span style="color:#111">ApiConfig</span><span style="color:#f92672">.</span><span style="color:#111">api_key</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">yFs2mPKxvfCC26C4vG3K</span><span style="color:#d88200">&#39;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="obtaining-data-from-quandl">Obtaining data from Quandl</h3>
<p>From Quandl&rsquo;s OWF ( OptionWorks Futures Options ) database, we obtain data of our future pair: ICE_T_T ( ICE WTI Crude Oil T Futures Options Implied Volatility Model ) and ICE_G_G ( ICE WTI Gas Oil Futures Options Implied Volatility Model ) from 2017-12-02 to 2019-08-31.</p>
<p>For this strategy, we use the second month futures prices to define our future prices. The definition of second month is the contract where the number of days to futures expiration is the smallest available value greater than 30.</p>
<p>speck
gas oil：metre tonne
crude oil：barrel
7.45</p>
<h3 id="relationship-between-the-spread-pair-wti-crude-oil-and-gas-oil-ice_t_t-and-ice_g_g">Relationship between the spread pair (WTI Crude Oil and Gas Oil) (ICE_T_T and ICE_G_G)</h3>
<p>We now look at the relationship between crede oil and gas oil in the real world. Here&rsquo;s the relationship between those two:
<img src="https://marketrealist.imgix.net/uploads/2016/11/Refining.jpg?auto=compress%2Cformat&amp;fit=scale&amp;h=auto&amp;ixlib=php-1.2.1&amp;w=696&amp;wpsize=medium696w" alt=""></p>
<p>From the picture, we could see that both light gas oil and heavy gas oil are the product of the crude distillation, which means they&rsquo;re high correlated with each other. Gas oil price is higher than crude oil since during the process of production, it adds refinement value to the gas oil. That&rsquo;s why their difference are relatively the same as the time changes.</p>
<p>One thing which is also worth meantioning is that the unit of Crude Futures is barrel, and the trading unite of the Gas Oil Futures is metric tonne. By researching, I found out that 1 metric tonne is relatively 7.45 barrels. That&rsquo;s why during our calculation of spread, we need the multiplier 1/7.45 below.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">sdate</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">2017-12-02</span><span style="color:#d88200">&#39;</span>
<span style="color:#111">edate</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">2019-08-31</span><span style="color:#d88200">&#39;</span>

<span style="color:#111">cache</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#111">month</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">H</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">M</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">U</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Z</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
<span style="color:#111">year</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">2018</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">2019</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
<span style="color:#111">list_of_X</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#111">]</span>
<span style="color:#111">list_of_Y</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#111">]</span>

<span style="color:#00a8c8">def</span> <span style="color:#75af00">get</span><span style="color:#111">(</span><span style="color:#111">symbol</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">symbol</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> <span style="color:#111">cache</span><span style="color:#111">:</span> <span style="color:#111">cache</span><span style="color:#111">[</span><span style="color:#111">symbol</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">quandl</span><span style="color:#f92672">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#111">symbol</span><span style="color:#111">,</span> <span style="color:#111">start_date</span><span style="color:#f92672">=</span><span style="color:#111">sdate</span><span style="color:#111">,</span> <span style="color:#111">end_date</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">2020-04-01</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">cache</span><span style="color:#111">[</span><span style="color:#111">symbol</span><span style="color:#111">]</span>

<span style="color:#00a8c8">for</span> <span style="color:#111">n</span> <span style="color:#f92672">in</span> <span style="color:#111">year</span><span style="color:#111">:</span>
    <span style="color:#00a8c8">for</span> <span style="color:#111">m</span> <span style="color:#f92672">in</span> <span style="color:#111">month</span><span style="color:#111">:</span>
        <span style="color:#111">futureX</span> <span style="color:#f92672">=</span> <span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">OWF/ICE_T_T_{m}{n}_IVM</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
        <span style="color:#111">futureY</span> <span style="color:#f92672">=</span> <span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">OWF/ICE_G_G_{m}{n}_IVM</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
        <span style="color:#111">futureX</span> <span style="color:#f92672">=</span> <span style="color:#111">futureX</span><span style="color:#111">[</span><span style="color:#111">futureX</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">DtT</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">30</span><span style="color:#111">]</span>
        <span style="color:#111">futureY</span> <span style="color:#f92672">=</span> <span style="color:#111">futureY</span><span style="color:#111">[</span><span style="color:#111">futureY</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">DtT</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">30</span><span style="color:#111">]</span>
        <span style="color:#111">list_of_X</span><span style="color:#f92672">.</span><span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#111">futureX</span><span style="color:#111">)</span>
        <span style="color:#111">list_of_Y</span><span style="color:#f92672">.</span><span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#111">futureY</span><span style="color:#111">)</span>

<span style="color:#111">X_price</span> <span style="color:#f92672">=</span> <span style="color:#111">dict</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">Y_price</span> <span style="color:#f92672">=</span> <span style="color:#111">dict</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">multiplier</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">7.45</span>

<span style="color:#00a8c8">for</span> <span style="color:#111">date</span> <span style="color:#f92672">in</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">bdate_range</span><span style="color:#111">(</span><span style="color:#111">sdate</span><span style="color:#111">,</span> <span style="color:#111">edate</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">list_of_X_available</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#111">X</span> <span style="color:#00a8c8">for</span> <span style="color:#111">X</span> <span style="color:#f92672">in</span> <span style="color:#111">list_of_X</span> <span style="color:#00a8c8">if</span> <span style="color:#111">date</span> <span style="color:#f92672">in</span> <span style="color:#111">X</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">]</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">list_of_X_available</span><span style="color:#111">:</span>
        <span style="color:#111">price</span> <span style="color:#f92672">=</span> <span style="color:#111">min</span><span style="color:#111">(</span><span style="color:#111">list_of_X_available</span><span style="color:#111">,</span> <span style="color:#111">key</span><span style="color:#f92672">=</span><span style="color:#00a8c8">lambda</span> <span style="color:#111">df</span><span style="color:#111">:</span> <span style="color:#111">df</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">DtT</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Future</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
        <span style="color:#111">X_price</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">price</span>
        
<span style="color:#00a8c8">for</span> <span style="color:#111">date</span> <span style="color:#f92672">in</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">bdate_range</span><span style="color:#111">(</span><span style="color:#111">sdate</span><span style="color:#111">,</span> <span style="color:#111">edate</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">list_of_Y_available</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#111">Y</span> <span style="color:#00a8c8">for</span> <span style="color:#111">Y</span> <span style="color:#f92672">in</span> <span style="color:#111">list_of_Y</span> <span style="color:#00a8c8">if</span> <span style="color:#111">date</span> <span style="color:#f92672">in</span> <span style="color:#111">Y</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">]</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">list_of_Y_available</span><span style="color:#111">:</span>
        <span style="color:#111">price</span> <span style="color:#f92672">=</span> <span style="color:#111">min</span><span style="color:#111">(</span><span style="color:#111">list_of_Y_available</span><span style="color:#111">,</span> <span style="color:#111">key</span><span style="color:#f92672">=</span><span style="color:#00a8c8">lambda</span> <span style="color:#111">df</span><span style="color:#111">:</span> <span style="color:#111">df</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">DtT</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Future</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
        <span style="color:#111">Y_price</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">price</span>
        
<span style="color:#111">X_price</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">Series</span><span style="color:#111">(</span><span style="color:#111">X_price</span><span style="color:#111">)</span>
<span style="color:#111">Y_price</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">Series</span><span style="color:#111">(</span><span style="color:#111">Y_price</span><span style="color:#111">)</span>
<span style="color:#111">rt</span> <span style="color:#f92672">=</span> <span style="color:#111">multiplier</span> <span style="color:#f92672">*</span> <span style="color:#111">Y_price</span> <span style="color:#f92672">-</span> <span style="color:#111">X_price</span>
<span style="color:#111">X_pnl</span> <span style="color:#f92672">=</span> <span style="color:#111">X_price</span><span style="color:#f92672">.</span><span style="color:#111">diff</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">Y_pnl</span> <span style="color:#f92672">=</span> <span style="color:#111">Y_price</span><span style="color:#f92672">.</span><span style="color:#111">diff</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="3-strategy-and-backtest">3. Strategy and Backtest</h2>
<p>Several data we use here:</p>
<ul>
<li><strong>X_price</strong>: the price of Crude Oil Futures</li>
<li><strong>Y_price</strong>: the price of Gas Oil Futures</li>
</ul>
<p>After getting the data we need, we do several computations:</p>
<ul>
<li><strong>Raw Spread (rt)</strong>: multiplier * Y_price - X_price</li>
<li><strong>Moving Average (MA)</strong>: moving average of raw spread</li>
<li><strong>Stretegy spread (st)</strong>: rt - MA</li>
</ul>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">data</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">(</span><span style="color:#111">rt</span><span style="color:#111">,</span> <span style="color:#111">columns</span><span style="color:#f92672">=</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Raw spread</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">M</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
<span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">MA</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Raw spread</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">rolling</span><span style="color:#111">(</span><span style="color:#111">M</span><span style="color:#111">,</span> <span style="color:#111">min_periods</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Strategy Spread</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Raw spread</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">-</span> <span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">MA</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
</code></pre></td></tr></table>
</div>
</div><p>Firstly, we could plot the distribution (histogram) of the spread.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Strategy Spread</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/spread_trading/spread_distribution.png" alt="picture alt"></p>
<p>Also, we could plot the fitted normal distribution and t-distribution in order to compare.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">fig</span> <span style="color:#f92672">=</span> <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">figure</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">ax</span> <span style="color:#f92672">=</span> <span style="color:#111">fig</span><span style="color:#f92672">.</span><span style="color:#111">add_subplot</span><span style="color:#111">(</span><span style="color:#ae81ff">111</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">hist</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Strategy Spread</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">bins</span><span style="color:#f92672">=</span><span style="color:#ae81ff">40</span><span style="color:#111">,</span> <span style="color:#111">density</span><span style="color:#f92672">=</span><span style="color:#111">True</span><span style="color:#111">)</span>
<span style="color:#111">x_grid</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">linspace</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#ae81ff">6</span><span style="color:#111">,</span> <span style="color:#ae81ff">6</span><span style="color:#111">,</span> <span style="color:#ae81ff">1200</span><span style="color:#111">)</span>

<span style="color:#111">params1</span> <span style="color:#f92672">=</span> <span style="color:#111">stats</span><span style="color:#f92672">.</span><span style="color:#111">norm</span><span style="color:#f92672">.</span><span style="color:#111">fit</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Strategy Spread</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">fit_pdf1</span> <span style="color:#f92672">=</span> <span style="color:#111">stats</span><span style="color:#f92672">.</span><span style="color:#111">norm</span><span style="color:#f92672">.</span><span style="color:#111">pdf</span><span style="color:#111">(</span><span style="color:#111">x_grid</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#111">params1</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">x_grid</span><span style="color:#111">,</span> <span style="color:#111">fit_pdf1</span><span style="color:#111">,</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Normal</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">params2</span> <span style="color:#f92672">=</span> <span style="color:#111">stats</span><span style="color:#f92672">.</span><span style="color:#111">t</span><span style="color:#f92672">.</span><span style="color:#111">fit</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Strategy Spread</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">fit_pdf2</span> <span style="color:#f92672">=</span> <span style="color:#111">stats</span><span style="color:#f92672">.</span><span style="color:#111">t</span><span style="color:#f92672">.</span><span style="color:#111">pdf</span><span style="color:#111">(</span><span style="color:#111">x_grid</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#111">params2</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">x_grid</span><span style="color:#111">,</span> <span style="color:#111">fit_pdf2</span><span style="color:#111">,</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">t</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span>

<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">set_xlabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Strategy Spread</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">set_ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">density</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/spread_trading/fit_normal_t.png" alt="picture alt"></p>
<p>From the histrogram of the strategy spread, we could see that normal and t distribution both fit the distribution pretty well, which implies that it is normal distributed.</p>
<h4 id="stationarity-test">Stationarity test</h4>
<p>In order to do the spread trading, we assume the pair&rsquo;s spread is stational. Before actually testing the strategy and tuning the parameter, we firstly check the stionarity of the spread by doing the Ad-Fuller test.</p>
<p>We do the Unit-Root test, so our null hypothesis is that the strategy spread only has one unit root.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">ad_result</span> <span style="color:#f92672">=</span> <span style="color:#111">adfuller</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Strategy Spread</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">ad_result</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>(-5.36982767996684,
 3.918169723518303e-06,
 13,
 435,
 {'1%': -3.4454725477848998,
  '5%': -2.8682072297316794,
  '10%': -2.570321396485665},
 1052.6004685638443)
</code></pre>
<p>Since the p-value in the test is 3.918169723518303e-06, which is far less than 0.05, so we could reject the null hypothesis and draw the conclusion that the spread has stationarity and we could use the pair to do spread trading.</p>
<h3 id="backtest">Backtest</h3>
<p>Backtest is where we use the historical data to test our strategy. The logic of the backtest is the rule of the spread strategy I mentioned at the beginning of this notebook. Here, I wrote a function Backtest with the parameter S, M, g and j, which are the thresholds of our spread strategy. The Backtest returns the strategy&rsquo;s daily pnl series with certain parameters we set at the beginning of the function.</p>
<p>For details of the backtest, I make comments of every crutial step.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">def</span> <span style="color:#75af00">backtest</span><span style="color:#111">(</span><span style="color:#111">S</span><span style="color:#111">,</span> <span style="color:#111">M</span><span style="color:#111">,</span> <span style="color:#111">g</span><span style="color:#111">,</span> <span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">st</span> <span style="color:#f92672">=</span> <span style="color:#111">rt</span> <span style="color:#f92672">-</span> <span style="color:#111">rt</span><span style="color:#f92672">.</span><span style="color:#111">rolling</span><span style="color:#111">(</span><span style="color:#111">M</span><span style="color:#111">,</span> <span style="color:#111">min_periods</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span>  <span style="color:#75715e"># strategy spread</span>
    
    <span style="color:#111">daily_pnl_series</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#111">]</span>  <span style="color:#75715e"># list of daily PNL</span>
    <span style="color:#111">total_value</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e6</span>  <span style="color:#75715e"># initial capital</span>
    <span style="color:#111">x_pos</span> <span style="color:#f92672">=</span> <span style="color:#111">y_pos</span> <span style="color:#f92672">=</span> <span style="color:#111">tmr_pos</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># set initial spread position to 0 </span>
    <span style="color:#111">prev_day</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>  <span style="color:#75715e"># the day before &#34;today&#34; </span>
    <span style="color:#111">stoploss</span> <span style="color:#f92672">=</span> <span style="color:#111">False</span>  <span style="color:#75715e"># indicator: true if currently we&#39;re end of every month or we need to stop in order to stop the loss</span>
    <span style="color:#111">first_day</span> <span style="color:#f92672">=</span> <span style="color:#111">st</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>  <span style="color:#75715e"># the first trading day</span>
    
    <span style="color:#00a8c8">for</span> <span style="color:#111">date</span> <span style="color:#f92672">in</span> <span style="color:#111">st</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">:</span>
        <span style="color:#111">tdy_pos</span> <span style="color:#f92672">=</span> <span style="color:#111">tmr_pos</span>  <span style="color:#75715e"># every round of for loop, set today&#39;s opening position equal to yesterday&#39;s closing position</span>
        
        <span style="color:#00a8c8">if</span> <span style="color:#111">date</span><span style="color:#f92672">.</span><span style="color:#111">day</span> <span style="color:#f92672">&lt;</span> <span style="color:#111">prev_day</span><span style="color:#111">:</span>
            <span style="color:#111">tdy_pos</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># if it&#39;s first day of the month, then no position</span>
            <span style="color:#111">stoploss</span> <span style="color:#f92672">=</span> <span style="color:#111">False</span>  <span style="color:#75715e"># reset stoploss status on the first day of the month</span>
        <span style="color:#00a8c8">if</span> <span style="color:#111">stoploss</span><span style="color:#111">:</span>
            <span style="color:#111">tdy_pos</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># if it&#39;s during stop loss period, then no position</span>
        
        <span style="color:#111">prev_day</span> <span style="color:#f92672">=</span> <span style="color:#111">date</span><span style="color:#f92672">.</span><span style="color:#111">day</span>  <span style="color:#75715e"># reset prev_day to be today&#39;s date</span>
        
        <span style="color:#00a8c8">if</span> <span style="color:#111">date</span> <span style="color:#f92672">!=</span> <span style="color:#111">first_day</span><span style="color:#111">:</span>
            <span style="color:#111">tdy_x_pnl</span> <span style="color:#f92672">=</span> <span style="color:#111">X_pnl</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span>  <span style="color:#75715e"># today&#39;s X&#39;s PNL</span>
            <span style="color:#111">tdy_y_pnl</span> <span style="color:#f92672">=</span> <span style="color:#111">Y_pnl</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span>  <span style="color:#75715e"># today&#39;s Y&#39;s PNL</span>
            <span style="color:#111">daily_pnl</span> <span style="color:#f92672">=</span> <span style="color:#111">tdy_x_pnl</span> <span style="color:#f92672">*</span> <span style="color:#111">x_pos</span> <span style="color:#f92672">+</span> <span style="color:#111">tdy_y_pnl</span> <span style="color:#f92672">*</span> <span style="color:#111">y_pos</span>  <span style="color:#75715e"># today&#39;s PNL </span>
        <span style="color:#00a8c8">else</span><span style="color:#111">:</span>
            <span style="color:#111">daily_pnl</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#111">daily_pnl_series</span><span style="color:#f92672">.</span><span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#111">daily_pnl</span><span style="color:#111">)</span>  <span style="color:#75715e"># append today&#39;s PNL into the list of daily PNL</span>
        <span style="color:#111">total_value</span> <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#111">daily_pnl</span>  <span style="color:#75715e"># update total capital every day </span>

        <span style="color:#00a8c8">if</span> <span style="color:#111">tdy_pos</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
            <span style="color:#00a8c8">if</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">g</span><span style="color:#111">:</span>
                <span style="color:#111">tmr_pos</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
            <span style="color:#00a8c8">elif</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">g</span><span style="color:#111">:</span>
                <span style="color:#111">tmr_pos</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
            <span style="color:#00a8c8">elif</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#111">g</span> <span style="color:#f92672">and</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#111">g</span><span style="color:#111">:</span>
                <span style="color:#00a8c8">pass</span>
    
        <span style="color:#00a8c8">elif</span> <span style="color:#111">tdy_pos</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
            <span style="color:#00a8c8">if</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">g</span><span style="color:#111">:</span>
                <span style="color:#111">tmr_pos</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
            <span style="color:#00a8c8">elif</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">:</span>
                <span style="color:#00a8c8">pass</span>
            <span style="color:#00a8c8">elif</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span> <span style="color:#f92672">and</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#111">g</span><span style="color:#111">:</span>
                <span style="color:#111">tmr_pos</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
                
        <span style="color:#00a8c8">elif</span> <span style="color:#111">tdy_pos</span> <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">:</span>
            <span style="color:#00a8c8">if</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">:</span>
                <span style="color:#00a8c8">pass</span>
            <span style="color:#00a8c8">elif</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">g</span><span style="color:#111">:</span>
                <span style="color:#111">tmr_pos</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
            <span style="color:#00a8c8">elif</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#111">g</span> <span style="color:#f92672">and</span> <span style="color:#111">st</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#111">j</span><span style="color:#111">:</span>
                <span style="color:#111">tmr_pos</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        
        <span style="color:#00a8c8">if</span> <span style="color:#111">tdy_pos</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">and</span> <span style="color:#111">tmr_pos</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>  <span style="color:#75715e"># update X position and Y position if we start a new trading</span>
            <span style="color:#111">x_pos</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#111">round</span><span style="color:#111">(</span><span style="color:#111">total_value</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">/</span> <span style="color:#111">X_price</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#111">tmr_pos</span>
            <span style="color:#111">y_pos</span> <span style="color:#f92672">=</span> <span style="color:#111">round</span><span style="color:#111">(</span><span style="color:#111">total_value</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">/</span> <span style="color:#111">Y_price</span><span style="color:#111">[</span><span style="color:#111">date</span><span style="color:#111">]</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#111">tmr_pos</span>
            
        <span style="color:#00a8c8">if</span> <span style="color:#111">date</span> <span style="color:#f92672">!=</span> <span style="color:#111">first_day</span><span style="color:#111">:</span> 
            <span style="color:#00a8c8">if</span> <span style="color:#111">daily_pnl</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">S</span> <span style="color:#f92672">*</span> <span style="color:#111">total_value</span><span style="color:#111">:</span>
                <span style="color:#111">stoploss</span> <span style="color:#f92672">=</span> <span style="color:#111">True</span>  <span style="color:#75715e"># to determine when to start a stoploss</span>
    
    <span style="color:#111">daily_pnl_series</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">Series</span><span style="color:#111">(</span><span style="color:#111">daily_pnl_series</span><span style="color:#111">,</span> <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">st</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">daily_pnl_series</span>
</code></pre></td></tr></table>
</div>
</div><p>Here, I choose a set of thresholds (S=0.01, M=5, g=0.5, j=0.4) in order to make illustrations. After getting the daily_pnl series of the strategy, we could easily draw the cumulative_pnl plot to show the strategy&rsquo;s performance.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">daily_pnl</span> <span style="color:#f92672">=</span> <span style="color:#111">backtest</span><span style="color:#111">(</span><span style="color:#ae81ff">0.01</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">,</span> <span style="color:#f92672">.</span><span style="color:#ae81ff">5</span><span style="color:#111">,</span> <span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#111">)</span>
<span style="color:#111">cum_pnl</span> <span style="color:#f92672">=</span> <span style="color:#111">daily_pnl</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1e6</span>
<span style="color:#111">cum_pnl</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/spread_trading/pnl_before_tune.png" alt="picture alt"></p>
<h3 id="parameter-tuning">Parameter Tuning</h3>
<p>Clearly, choosing thresholds by hands is not working here. It&rsquo;s not efficient. More importantly, it&rsquo;s not gonna help us find the best strategy. That&rsquo;s why we should do the parameter tuning here. Before getting into that, I also want to use four indexes to judge if the strategy is good enough.</p>
<p>They are:</p>
<ul>
<li>Sharpe Ratio: return of an investment compared to its risk</li>
<li>Sortino Ratio: risk-adjusted return of a strategy</li>
<li>Maximnm Drawdown: maximum observed loss from a peak to a trough</li>
<li>Winning Rate: the percentage of winning</li>
</ul>
<h4 id="create-sharpe-ratio-function">Create Sharpe Ratio function.</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">sharpe</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">lambda</span> <span style="color:#111">x</span><span style="color:#111">:</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">std</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">252</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="create-sortino-ratio-function">Create Sortino Ratio function.</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">sortino</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">lambda</span> <span style="color:#111">x</span><span style="color:#111">:</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#111">(</span><span style="color:#111">(</span><span style="color:#111">x</span> <span style="color:#f92672">-</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#111">(</span><span style="color:#111">x</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">252</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="create-maximum-drawdown-function">Create Maximum Drawdown function.</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">def</span> <span style="color:#75af00">maximum_drawdown</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">,</span> <span style="color:#111">initial_value</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1e6</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">v</span> <span style="color:#f92672">=</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#111">initial_value</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> <span style="color:#111">v</span> <span style="color:#f92672">/</span> <span style="color:#111">v</span><span style="color:#f92672">.</span><span style="color:#111">cummax</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">max</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="create-winning-rate-function">Create Winning Rate function.</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">win_rate</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">lambda</span> <span style="color:#111">x</span><span style="color:#111">:</span> <span style="color:#111">(</span><span style="color:#111">x</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="set-parameter-grids">Set parameter grids.</h4>
<p>Since there&rsquo;re only four parameters in our paremeter tuning, I choose to use a simple for-loop ( actually there&rsquo;re four layers of calculations here ) instead of machine learning method. The advantage of this method is that by setting one index ( I use Sharpe Ratio here to be the index ), it is efficient to compute. However, there&rsquo;re also disadvantages of this method. We could not look at the four indexes at the same time.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">S_grid</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">arange</span><span style="color:#111">(</span><span style="color:#ae81ff">0.01</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.11</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.1</span><span style="color:#111">)</span>
<span style="color:#111">M_grid</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#ae81ff">5</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#ae81ff">15</span><span style="color:#111">,</span> <span style="color:#ae81ff">20</span><span style="color:#111">]</span>
<span style="color:#111">g_grid</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">arange</span><span style="color:#111">(</span><span style="color:#ae81ff">0.1</span><span style="color:#111">,</span> <span style="color:#ae81ff">3.1</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.1</span><span style="color:#111">)</span>
<span style="color:#111">j_grid</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">arange</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#ae81ff">2.1</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.1</span><span style="color:#111">)</span>
<span style="color:#111">params_grid</span> <span style="color:#f92672">=</span> <span style="color:#111">list</span><span style="color:#111">(</span><span style="color:#111">product</span><span style="color:#111">(</span><span style="color:#111">S_grid</span><span style="color:#111">,</span> <span style="color:#111">M_grid</span><span style="color:#111">,</span> <span style="color:#111">g_grid</span><span style="color:#111">,</span> <span style="color:#111">j_grid</span><span style="color:#111">)</span><span style="color:#111">)</span>

<span style="color:#111">max_sharpe</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#111">float</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">inf</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#00a8c8">for</span> <span style="color:#111">params</span> <span style="color:#f92672">in</span> <span style="color:#111">tqdm</span><span style="color:#111">(</span><span style="color:#111">params_grid</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">daily_pnl</span> <span style="color:#f92672">=</span> <span style="color:#111">backtest</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">params</span><span style="color:#111">)</span>
    <span style="color:#111">sharpe_ratio</span> <span style="color:#f92672">=</span> <span style="color:#111">sharpe</span><span style="color:#111">(</span><span style="color:#111">daily_pnl</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">sharpe_ratio</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">max_sharpe</span><span style="color:#111">:</span>
        <span style="color:#111">max_sharpe</span> <span style="color:#f92672">=</span> <span style="color:#111">sharpe_ratio</span>
        <span style="color:#111">best_params</span> <span style="color:#f92672">=</span> <span style="color:#111">params</span>

<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The best params are S = {:.2f}, M = {:.0f}, g = {:.1f} and j = {:.1f} with the best Sharpe Ratio {:.2f}.</span><span style="color:#d88200">&#39;</span><span style="color:#f92672">.</span><span style="color:#111">format</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">best_params</span><span style="color:#111">,</span> <span style="color:#111">max_sharpe</span><span style="color:#111">)</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The best params are S = 0.01, M = 20, g = 3.0000000000000004 and j = 2.0000000000000036 with the best Sharpe Ratio 2.503240431597306.
</code></pre>
<p>After the parameting tuning, we could compute the four functions seperately to see the performance of this set of thresholds. From the result, we could see that the Sharpe Ratio of this strategy is 2.5, which is pretty high here.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">func</span><span style="color:#111">(</span><span style="color:#111">backtest</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">best_params</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">func</span> <span style="color:#f92672">in</span> <span style="color:#111">[</span><span style="color:#111">sharpe</span><span style="color:#111">,</span> <span style="color:#111">sortino</span><span style="color:#111">,</span> <span style="color:#111">maximum_drawdown</span><span style="color:#111">,</span> <span style="color:#111">win_rate</span><span style="color:#111">]</span><span style="color:#111">]</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>[2.503240431597306, 3.99927975276015, 0.046804254666939826, 0.5412026726057907]
</code></pre>
<p>To see if the parameter tuning actually works, I also compute the four indexes of the previous set of thresholds I randomly picked. From the result, we could see that although we only use the Sharpe Ratio to optimize the performance of our strategy, all of my four indexes improved, which means although there&rsquo;re limitations of the parameter tuning, it&rsquo;s still a solid overall improvement of my strategy.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">func</span><span style="color:#111">(</span><span style="color:#111">backtest</span><span style="color:#111">(</span><span style="color:#ae81ff">0.01</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">,</span> <span style="color:#f92672">.</span><span style="color:#ae81ff">5</span><span style="color:#111">,</span> <span style="color:#f92672">.</span><span style="color:#ae81ff">4</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">func</span> <span style="color:#f92672">in</span> <span style="color:#111">[</span><span style="color:#111">sharpe</span><span style="color:#111">,</span> <span style="color:#111">sortino</span><span style="color:#111">,</span> <span style="color:#111">maximum_drawdown</span><span style="color:#111">,</span> <span style="color:#111">win_rate</span><span style="color:#111">]</span><span style="color:#111">]</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>[1.218223449118886, 1.8641248661345056, 0.0533043738617216, 0.5100222717149221]
</code></pre>
<p>Like before, I also draw the cumulative return plot of the optimized strategy here. From the strategy, we could tell the optimization is pretty solid. The overall return in the end of the time period we choose is almost 70%. What&rsquo;s more, the performance is more stable and less volatile, which is good for traders and investors.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">best_cum</span> <span style="color:#f92672">=</span> <span style="color:#111">backtest</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">best_params</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1e6</span>
<span style="color:#111">best_cum</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/spread_trading/pnl_after_tune.png" alt="picture alt"></p>
<h2 id="4-regression-analysis">4. Regression Analysis</h2>
<p>After the spread strategy, we could also combine our spread strategy with the Fama-French factor(s). By holding the opposite position of Fama-French foctor(s), we hedge the risk of the spread strategy itself.</p>
<p>About the Fama-French model factors, there&rsquo;re three factors:</p>
<ul>
<li><strong>Small Minus Big (SMB)</strong>: &ldquo;size effect&rdquo;, small companies overperform larger ones over the long-term</li>
<li><strong>High Minus Low (HML)</strong>: outperformance of value stocks over growth stocks</li>
<li><strong>Excess Return (Mkt-Rf)</strong>: excess return of the market</li>
</ul>
<p>By using Ordinary Least Squares regression, we hedge the risk of our spread strategy by holding opposite positions of SMB/HML/Mkt-Rf or the three Fama-French factors together. The residual of our regression will be the daily pnl series of the strategy. By analyzing that, we could see the performance and determine if the hegde works.</p>
<h3 id="obtain-data-of-daily-fama-french-factor-returns">Obtain data of daily Fama-French factor returns</h3>
<p>We obtain the daily Fama-French factor returns from Ken French&rsquo;s website.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">ff_factors</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">../HW2/F-F_Research_Data_Factors_daily.CSV</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">header</span><span style="color:#f92672">=</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span> <span style="color:#111">index_col</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">ff_factors</span> <span style="color:#f92672">=</span> <span style="color:#111">ff_factors</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#111">:</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
<span style="color:#111">ff_factors</span><span style="color:#f92672">.</span><span style="color:#111">index</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">to_datetime</span><span style="color:#111">(</span><span style="color:#111">ff_factors</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span>
<span style="color:#111">ff_factors</span> <span style="color:#f92672">=</span> <span style="color:#111">ff_factors</span><span style="color:#111">[</span><span style="color:#111">sdate</span><span style="color:#111">:</span><span style="color:#111">edate</span><span style="color:#111">]</span>
<span style="color:#111">ff_factors</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">PNL</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">backtest</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">best_params</span><span style="color:#111">)</span>
<span style="color:#111">ff_factors</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Mkt_RF</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">SMB</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">HML</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">RF</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">PNL</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
<span style="color:#111">ff_factors</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="regression-between-daily_pnl-of-the-spread-strategy-and-fama-french-factor-smb">Regression between daily_pnl of the spread strategy and fama-french factor &ldquo;SMB&rdquo;</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">model_smb</span> <span style="color:#f92672">=</span> <span style="color:#111">smf</span><span style="color:#f92672">.</span><span style="color:#111">ols</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">PNL ~ SMB + 0</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">data</span><span style="color:#f92672">=</span><span style="color:#111">ff_factors</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">fit</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">model_smb</span><span style="color:#f92672">.</span><span style="color:#111">summary</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>                                 OLS Regression Results                                
=======================================================================================
Dep. Variable:                    PNL   R-squared (uncentered):                   0.008
Model:                            OLS   Adj. R-squared (uncentered):              0.006
Method:                 Least Squares   F-statistic:                              3.507
Date:                Wed, 22 Apr 2020   Prob (F-statistic):                      0.0618
Time:                        21:47:45   Log-Likelihood:                         -4636.0
No. Observations:                 438   AIC:                                      9274.
Df Residuals:                     437   BIC:                                      9278.
Df Model:                           1                                                  
Covariance Type:            nonrobust                                                  
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
SMB        -1680.5135    897.342     -1.873      0.062   -3444.155      83.128
==============================================================================
Omnibus:                      169.503   Durbin-Watson:                   1.950
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             1364.249
Skew:                           1.441   Prob(JB):                    5.71e-297
Kurtosis:                      11.152   Cond. No.                         1.00
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">cum_smb</span> <span style="color:#f92672">=</span> <span style="color:#111">model_smb</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1e6</span>
<span style="color:#111">cum_smb</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/spread_trading/spread_smb.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">func</span><span style="color:#111">(</span><span style="color:#111">model_smb</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">func</span> <span style="color:#f92672">in</span> <span style="color:#111">[</span><span style="color:#111">sharpe</span><span style="color:#111">,</span> <span style="color:#111">sortino</span><span style="color:#111">,</span> <span style="color:#111">maximum_drawdown</span><span style="color:#111">,</span> <span style="color:#111">win_rate</span><span style="color:#111">]</span><span style="color:#111">]</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>[2.505257399243229, 4.025154172157131, 0.04379745877202246, 0.5616438356164384]
</code></pre>
<p>From the cumulative return plot and the four indexes we could see that, although the performance of this hedge is good, comparing with the spread strategy itself, it does not become better, which means the hedge does not optimize the strategy.</p>
<p>From my perspective, I think the reason why this hedge may be a good strategy is that SMB represents the idiosyncratic risks of individual companies in the market. By doing this hedge, we&rsquo;re actually hedging out these risk factors.</p>
<h4 id="regression-between-daily_pnl-of-the-spread-strategy-and-fama-french-factor-hml">Regression between daily_pnl of the spread strategy and fama-french factor &ldquo;HML&rdquo;</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">model_hml</span> <span style="color:#f92672">=</span> <span style="color:#111">smf</span><span style="color:#f92672">.</span><span style="color:#111">ols</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">PNL ~ HML + 0</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">data</span><span style="color:#f92672">=</span><span style="color:#111">ff_factors</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">fit</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">model_hml</span><span style="color:#f92672">.</span><span style="color:#111">summary</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>                                 OLS Regression Results                                
=======================================================================================
Dep. Variable:                    PNL   R-squared (uncentered):                   0.002
Model:                            OLS   Adj. R-squared (uncentered):             -0.000
Method:                 Least Squares   F-statistic:                             0.8283
Date:                Wed, 22 Apr 2020   Prob (F-statistic):                       0.363
Time:                        21:39:23   Log-Likelihood:                         -4637.3
No. Observations:                 438   AIC:                                      9277.
Df Residuals:                     437   BIC:                                      9281.
Df Model:                           1                                                  
Covariance Type:            nonrobust                                                  
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
HML         -735.0567    807.672     -0.910      0.363   -2322.462     852.349
==============================================================================
Omnibus:                      160.188   Durbin-Watson:                   1.965
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             1194.160
Skew:                           1.369   Prob(JB):                    4.92e-260
Kurtosis:                      10.612   Cond. No.                         1.00
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">cum_hml</span> <span style="color:#f92672">=</span> <span style="color:#111">model_hml</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1e6</span>
<span style="color:#111">cum_hml</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/spread_trading/spread_hml.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">func</span><span style="color:#111">(</span><span style="color:#111">model_hml</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">func</span> <span style="color:#f92672">in</span> <span style="color:#111">[</span><span style="color:#111">sharpe</span><span style="color:#111">,</span> <span style="color:#111">sortino</span><span style="color:#111">,</span> <span style="color:#111">maximum_drawdown</span><span style="color:#111">,</span> <span style="color:#111">win_rate</span><span style="color:#111">]</span><span style="color:#111">]</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>[2.490594369232336, 3.9826647643042516, 0.04296930198567317, 0.5388127853881278]
</code></pre>
<p>Same conlusion as the regression of SMB, although it&rsquo;s a good strategy, it did not outperform the original spread strategy in terms of the cumulative return and the four indexes.</p>
<h4 id="regression-between-daily_pnl-of-the-spread-strategy-and-fama-french-factor-mkt-rf">Regression between daily_pnl of the spread strategy and fama-french factor &ldquo;Mkt-RF&rdquo;</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">model_mkt</span> <span style="color:#f92672">=</span> <span style="color:#111">smf</span><span style="color:#f92672">.</span><span style="color:#111">ols</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">PNL ~ Mkt_RF + 0</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">data</span><span style="color:#f92672">=</span><span style="color:#111">ff_factors</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">fit</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">model_mkt</span><span style="color:#f92672">.</span><span style="color:#111">summary</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>                                 OLS Regression Results                                
=======================================================================================
Dep. Variable:                    PNL   R-squared (uncentered):                   0.037
Model:                            OLS   Adj. R-squared (uncentered):              0.035
Method:                 Least Squares   F-statistic:                              16.71
Date:                Wed, 22 Apr 2020   Prob (F-statistic):                    5.17e-05
Time:                        21:36:27   Log-Likelihood:                         -4545.0
No. Observations:                 438   AIC:                                      9092.
Df Residuals:                     437   BIC:                                      9096.
Df Model:                           1                                                  
Covariance Type:            nonrobust                                                  
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Mkt_RF     -1516.4122    370.913     -4.088      0.000   -2245.408    -787.416
==============================================================================
Omnibus:                       59.934   Durbin-Watson:                   2.670
Prob(Omnibus):                  0.000   Jarque-Bera (JB):              400.301
Skew:                          -0.316   Prob(JB):                     1.19e-87
Kurtosis:                       7.641   Cond. No.                         1.00
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">cum_mkt</span> <span style="color:#f92672">=</span> <span style="color:#111">model_mkt</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1e6</span>
<span style="color:#111">cum_mkt</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/spread_trading/spread_mktrf.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">func</span><span style="color:#111">(</span><span style="color:#111">model_mkt</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">func</span> <span style="color:#f92672">in</span> <span style="color:#111">[</span><span style="color:#111">sharpe</span><span style="color:#111">,</span> <span style="color:#111">sortino</span><span style="color:#111">,</span> <span style="color:#111">maximum_drawdown</span><span style="color:#111">,</span> <span style="color:#111">win_rate</span><span style="color:#111">]</span><span style="color:#111">]</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>[0.3184069744735868, 0.4461720053872383, 0.10328493002974315, 0.5068493150684932]
</code></pre>
<p>Unlike the previous two regressions we did, this hedge does not do well. The return is pretty low and the four indexes are also not impressive at all.</p>
<p>From my personal understanding, I‘m thiking maybe the reason is the crude oil and the gas oil (energy market) is so correlated with the market return that the spread between them are relatively small, which makes this kind of hedge&rsquo;s return not significant.</p>
<h4 id="regression-between-daily_pnl-of-the-spread-strategy-and-the-three-fama-french-factors">Regression between daily_pnl of the spread strategy and the three fama-french factors</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">model_ff</span> <span style="color:#f92672">=</span> <span style="color:#111">smf</span><span style="color:#f92672">.</span><span style="color:#111">ols</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">PNL ~ SMB + HML + Mkt_RF + 0</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">data</span><span style="color:#f92672">=</span><span style="color:#111">ff_factors</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">fit</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">model_ff</span><span style="color:#f92672">.</span><span style="color:#111">summary</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>                                 OLS Regression Results                                
=======================================================================================
Dep. Variable:                    PNL   R-squared (uncentered):                   0.011
Model:                            OLS   Adj. R-squared (uncentered):              0.005
Method:                 Least Squares   F-statistic:                              1.668
Date:                Wed, 22 Apr 2020   Prob (F-statistic):                       0.173
Time:                        21:49:20   Log-Likelihood:                         -4635.2
No. Observations:                 438   AIC:                                      9276.
Df Residuals:                     435   BIC:                                      9289.
Df Model:                           3                                                  
Covariance Type:            nonrobust                                                  
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
SMB        -1856.8941    910.402     -2.040      0.042   -3646.228     -67.560
HML        -1001.3976    849.643     -1.179      0.239   -2671.313     668.518
Mkt_RF        -3.8589    477.602     -0.008      0.994    -942.554     934.837
==============================================================================
Omnibus:                      161.307   Durbin-Watson:                   1.950
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             1200.859
Skew:                           1.381   Prob(JB):                    1.73e-261
Kurtosis:                      10.627   Cond. No.                         2.12
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">cum_ff</span> <span style="color:#f92672">=</span> <span style="color:#111">model_ff</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1e6</span>
<span style="color:#111">cum_ff</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/spread_trading/spread_ff.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">[</span><span style="color:#111">func</span><span style="color:#111">(</span><span style="color:#111">model_ff</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#111">)</span> <span style="color:#00a8c8">for</span> <span style="color:#111">func</span> <span style="color:#f92672">in</span> <span style="color:#111">[</span><span style="color:#111">sharpe</span><span style="color:#111">,</span> <span style="color:#111">sortino</span><span style="color:#111">,</span> <span style="color:#111">maximum_drawdown</span><span style="color:#111">,</span> <span style="color:#111">win_rate</span><span style="color:#111">]</span><span style="color:#111">]</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>[2.4056098457815827, 3.855107672834527, 0.04787717023424776, 0.5593607305936074]
</code></pre>
<p>Like the SMB and HML, using the Fama-French factors to hedge is a decent strategy. However, like the previous two hedges, it does not outperform the optimized version of our spread strategy.</p>
<h3 id="comparison">Comparison</h3>
<p>By plotting all the five return curves together, we could find out that our optimized spread strategy&rsquo;s performance after the paremeter tuning is the best.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">(</span><span style="color:#111">model_smb</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1e6</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">hedged-smb</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">(</span><span style="color:#111">model_ff</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1e6</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">hedged-ff</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">c</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">(</span><span style="color:#111">model_hml</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1e6</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">hedged-hml</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">(</span><span style="color:#111">model_mkt</span><span style="color:#f92672">.</span><span style="color:#111">resid</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1e6</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">hedged-mkt</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">(</span><span style="color:#111">backtest</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">best_params</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1e6</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">unhedged</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">k</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">legend</span><span style="color:#111">(</span><span style="color:#111">frameon</span><span style="color:#f92672">=</span><span style="color:#111">False</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/spread_trading/comparison.png" alt="picture alt"></p>
<h3 id="however">However&hellip;</h3>
<p>Here&rsquo;s one thing that some people may neglect about the regression/hedge that we did just now. We&rsquo;re using the future information to compute the regression and do the backtest, which is forward-looking. In the real world, we could not do this on any day within this time period unless we&rsquo;re looking back at the historical data. So even if the strategy is working and doing really well, we could not utilize it in the real world senario. A better alternative would be just use the in-sample data to do rolling regressions instead of one single large one for all.</p>
<h2 id="5-conclusion">5. Conclusion</h2>
<p>In a nutshell, spread trading on commodity markets, especially in our case, in energy markets, is exceptionally profitable mainly in that the different energy products are inner related - most are products of the few resources and the value-adds are relatively fixed over time. The same logic should apply in many other products and markets and we&rsquo;d be more than willing to dig into those.</p>

      </div>


      <footer>
        


        
        
        <script src="https://utteranc.es/client.js"
  repo= "christineeeeee/christineeeeee.github.io"
  issue-term="pathname"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script>
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
    
    
    
  </section>

</footer>

    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-171417581-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  </body>

</html>
