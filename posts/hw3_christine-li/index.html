<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Christine">
    
    

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Return predictions From Trade Flow"/>
<meta name="twitter:description" content="This is a strategy which is based on tick level analysis. The idea is that we use trade flow as our signals of the market to generate profit opportunities.
We define j as our trading threshold. Also, we need to decide proper $\tau$ as the backward trade interval and T as the forward trade interval.
1. Introduction Breif intro of the strategy.
Order Book and Trade Marking In the order book, there&rsquo;re two types of trades: bid and ask."/>

    <meta property="og:title" content="Return predictions From Trade Flow" />
<meta property="og:description" content="This is a strategy which is based on tick level analysis. The idea is that we use trade flow as our signals of the market to generate profit opportunities.
We define j as our trading threshold. Also, we need to decide proper $\tau$ as the backward trade interval and T as the forward trade interval.
1. Introduction Breif intro of the strategy.
Order Book and Trade Marking In the order book, there&rsquo;re two types of trades: bid and ask." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://christineeeeee.com/posts/hw3_christine-li/" />
<meta property="article:published_time" content="2020-04-25T13:24:30+00:00" />
<meta property="article:modified_time" content="2020-04-25T13:24:30+00:00" />


    
      <base href="https://christineeeeee.com/posts/hw3_christine-li/">
    
    <title>
  Return predictions From Trade Flow · Stop this train
</title>

    
      <link rel="canonical" href="https://christineeeeee.com/posts/hw3_christine-li/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.c6a6f7e4e5b9eae62968f9dee6cad8903a7a12c11df9305249ee05c53679cafe.css" integrity="sha256-xqb35OW56uYpaPne5srYkDp6EsEd&#43;TBSSe4FxTZ5yv4=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="/css/custom.css" />
    

    

    

    <link rel="icon" type="image/png" href="https://christineeeeee.com/images/avatar.jpg" sizes="32x32">
    <link rel="icon" type="image/png" href="https://christineeeeee.com/images/avatar.jpg" sizes="16x16">

    <meta name="generator" content="Hugo 0.63.1" />
  </head>

  
  
  <body class="colorscheme-light">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      Stop this train
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://christineeeeee.com/posts/">Posts</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://christineeeeee.com/pieces/">Pieces</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://christineeeeee.com/about/">About</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Return predictions From Trade Flow</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-04-25T13:24:30Z'>
                April 25, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              19-minute read
            </span>
          </div>
          
          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="/tags/python/">Python</a>
      <span class="separator">•</span>
    <a href="/tags/strategy/">Strategy</a></div>

        </div>
      </header>

      <div>
        
        <p>This is a strategy which is based on tick level analysis. The idea is that we use trade flow as our signals of the market to generate profit opportunities.</p>
<p>We define j as our trading threshold. Also, we need to decide proper $\tau$ as the backward trade interval and T as the forward trade interval.</p>
<h2 id="1--introduction">1.  Introduction</h2>
<p>Breif intro of the strategy.</p>
<h3 id="order-book-and-trade-marking">Order Book and Trade Marking</h3>
<p>In the order book, there&rsquo;re two types of trades: bid and ask. They&rsquo;re on the two opposite sides of the market and waiting for the matched price to set the deal. Buyers have their bid prices and sellers have their ask price. Buyers and sellers could change their offer prices when they find an optimal alternative. Also, they could cancel their initial positions and change sides. Usually, we use <strong>mid price</strong>, which is the average of bid and ask price to express the general market value of the asset people&rsquo;re trading.</p>
<p>According to some experts&rsquo; observations, there&rsquo;re several interesting &ldquo;rules&rdquo; in the market:</p>
<ul>
<li>
<p>When there&rsquo;re way more asks than bids(or vice versa), the clearing price that participants are willing to trade will be closer to the bid price than the mid price.</p>
</li>
<li>
<p>If many traders are crossing the spread in the same direction (bid to ask or vice versa), it&rsquo;s likely that there&rsquo;re more <strong>informed directional traders</strong> than <strong>noise traders</strong>(lack specific information) in the market.</p>
</li>
</ul>
<p>It&rsquo;s legit to make a speculation that there&rsquo;re some serial correlations between this kind of trading and the change of the asset price. At this point, we import the definition of trade marking, which means to mark the trade as &ldquo;seller-initiated&rdquo; or &ldquo;buyer-initiated&rdquo;. Here&rsquo;s the process of how to mark trades:</p>
<ul>
<li>Find the best bid and ask price</li>
<li>Compare the trade price to them</li>
<li>If the trade price equals the best bid price, then this trade is marked as &ldquo;seller-initiated&rdquo;</li>
<li>If the trade price equals the best ask price, then this trade is marked as &ldquo;buyer-initiated&rdquo;</li>
<li>If the above two rules don&rsquo;t apply, then mark as &ldquo;mid price&rdquo;</li>
</ul>
<h3 id="trade-flow">Trade Flow</h3>
<p><strong>Trade Flow</strong> is a running tally of signed trade sizes where the sign is defined as 1 if seller-initiated and -1 if buyer-initiated. In the defined last time period of length $\tau$, the trade flow is the volumn of the buyer-initiated trade subtract the volumn of the seller-initiated trade.</p>
<p>The intuition behind this strategy is that: if many traders are crossing the market-making spread at the same time period, it is likely that they&rsquo;re informed directional traders and they&rsquo;re driven by some new information.</p>
<h3 id="prediction-and-returns">Prediction and Returns</h3>
<p>We could use the trade flow as our signals and do linear regression to see how correlated this signal is with the return of the trade. After computing the linear regression of trade flow and returns, we could use the regression model to predict the future returns if we keep using this strategy.</p>
<p>The return of the strategy is the spread of log return of the entry-price we enter the position and the exit-price when we exit the position in T-second interval (T is well chosen by us).</p>
<h2 id="2-data-preparation-and-strategy">2. Data Preparation and Strategy</h2>
<h3 id="introduction-of-the-packages-in-the-spread-trading">Introduction of the packages in the spread trading</h3>
<p>We&rsquo;re using several really important python packages in this strategy:</p>
<ul>
<li><strong>Pandas</strong>: dataframe manipulation</li>
<li><strong>NumPy</strong>: support for mathematical functions and computation of arrays and matrics</li>
<li><strong>Statsmodel</strong>: statistical analysis</li>
<li><strong>Matplotlib</strong>: plot tools</li>
<li><strong>Seaborn</strong>: statistical data visualization</li>
<li><strong>Glob</strong>: retrieve files matching a specified pattern</li>
<li><strong>os</strong>: interact with the operating system</li>
<li><strong>P_map</strong>: realization of multi-processed mapping</li>
</ul>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> <span style="color:#111">os</span>
<span style="color:#f92672">from</span> <span style="color:#111">glob</span> <span style="color:#f92672">import</span> <span style="color:#111">glob</span>
<span style="color:#f92672">import</span> <span style="color:#111">pandas</span> <span style="color:#f92672">as</span> <span style="color:#111">pd</span>
<span style="color:#f92672">import</span> <span style="color:#111">numpy</span> <span style="color:#f92672">as</span> <span style="color:#111">np</span>
<span style="color:#f92672">import</span> <span style="color:#111">warnings</span>
<span style="color:#f92672">import</span> <span style="color:#111">statsmodels.formula.api</span> <span style="color:#f92672">as</span> <span style="color:#111">sm</span>
<span style="color:#f92672">from</span> <span style="color:#111">p_tqdm</span> <span style="color:#f92672">import</span> <span style="color:#111">p_map</span>
<span style="color:#f92672">import</span> <span style="color:#111">matplotlib.pyplot</span> <span style="color:#f92672">as</span> <span style="color:#111">plt</span>
<span style="color:#f92672">import</span> <span style="color:#111">seaborn</span> <span style="color:#f92672">as</span> <span style="color:#111">sns</span>
<span style="color:#f92672">from</span> <span style="color:#111">sklearn.metrics</span> <span style="color:#f92672">import</span> <span style="color:#111">mean_squared_error</span>

<span style="color:#111">warnings</span><span style="color:#f92672">.</span><span style="color:#111">filterwarnings</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ignore</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">rcParams</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">figure.figsize</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">rcParams</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">date.autoformatter.day</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">%</span><span style="color:#d88200">m/</span><span style="color:#d88200">%d</span><span style="color:#d88200">&#39;</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">rcParams</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">date.autoformatter.minute</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">%</span><span style="color:#d88200">H:</span><span style="color:#d88200">%</span><span style="color:#d88200">M</span><span style="color:#d88200">&#39;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="strategy">Strategy</h3>
<h4 id="0-several-variables-appeared-in-the-following-strategy">0. Several variables appeared in the following strategy:</h4>
<ul>
<li><strong>price</strong>: Series of mid prices of orders at certain timestamp</li>
<li><strong>trade</strong>: Dataframe of trade sign, size at certain timestamp</li>
<li><strong>entry_price</strong>: price when entering the position</li>
<li><strong>exit_price</strong>: price when exiting the position</li>
<li><strong>sample_back</strong>: subset of all the trades in the past that happened between time interval [t-$\tau$, t]</li>
<li><strong>sample_forward</strong>: subset of trades in the future time interval [t, t+T]</li>
<li><strong>V</strong>: volume of seller-initiated trades or buyer-initiated trades</li>
<li><strong>F</strong>: trade flow</li>
<li><strong>r</strong>: return of each trade</li>
</ul>
<h4 id="1-trade-flow-and-returns">1. Trade Flow and Returns:</h4>
<p>For each stock, after setting the <strong>$\tau$</strong> and <strong>T</strong>, for backward sample from timestamp t-$\tau$ to t, we calculate the trade flow. Then, for forward sample from <strong>t</strong> to <strong>t+T</strong>, we enter the position at t, hold the position for T seconds and then exit the position at T. We could use the entry price and exit price to calculate the return of each trade.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">for</span> <span style="color:#111">pair</span> <span style="color:#f92672">in</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">BTC-USD</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ETH-USD</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">ETH-BTC</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">:</span>
    
    <span style="color:#111">filename</span> <span style="color:#f92672">=</span> <span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">../HW3/results_{pair}.csv</span><span style="color:#d88200">&#39;</span>

    <span style="color:#00a8c8">if</span> <span style="color:#111">os</span><span style="color:#f92672">.</span><span style="color:#111">path</span><span style="color:#f92672">.</span><span style="color:#111">isfile</span><span style="color:#111">(</span><span style="color:#111">filename</span><span style="color:#111">)</span><span style="color:#111">:</span>
        <span style="color:#111">results</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#111">filename</span><span style="color:#111">,</span> <span style="color:#111">index_col</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">parse_dates</span><span style="color:#f92672">=</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span><span style="color:#111">)</span>
        
    <span style="color:#00a8c8">else</span><span style="color:#111">:</span>
        <span style="color:#111">book</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">../HW3/data/book_narrow_{pair}_2018.delim</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">sep</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">|</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
        <span style="color:#111">trades</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">../HW3/data/trades_narrow_{pair}_2018.delim</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">sep</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">|</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
        
        
        <span style="color:#111">book</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">received_utc_nanoseconds</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">to_datetime</span><span style="color:#111">(</span><span style="color:#111">book</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">received_utc_nanoseconds</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
        <span style="color:#111">price</span> <span style="color:#f92672">=</span> <span style="color:#111">book</span><span style="color:#111">[</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">received_utc_nanoseconds</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Mid</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">]</span>
        <span style="color:#111">price</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">time</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">mid</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
        <span style="color:#111">price</span> <span style="color:#f92672">=</span> <span style="color:#111">price</span><span style="color:#f92672">.</span><span style="color:#111">set_index</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">time</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mid</span>
        <span style="color:#111">price</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">name</span> <span style="color:#f92672">=</span> <span style="color:#111">price</span><span style="color:#f92672">.</span><span style="color:#111">name</span> <span style="color:#f92672">=</span> <span style="color:#111">None</span>
        
        
        <span style="color:#111">trades</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">received_utc_nanoseconds</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">to_datetime</span><span style="color:#111">(</span><span style="color:#111">trades</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">received_utc_nanoseconds</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span>
        <span style="color:#75715e"># trades[&#39;timestamp_utc_nanoseconds&#39;] = pd.to_datetime(trades[&#39;timestamp_utc_nanoseconds&#39;])</span>
        <span style="color:#111">trades</span> <span style="color:#f92672">=</span> <span style="color:#111">trades</span><span style="color:#111">[</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">received_utc_nanoseconds</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Side</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">PriceMillionths</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">SizeBillionths</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">]</span>
        <span style="color:#111">trades</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">time</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">side</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">price</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">size</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
        <span style="color:#111">trades</span> <span style="color:#f92672">=</span> <span style="color:#111">trades</span><span style="color:#f92672">.</span><span style="color:#111">set_index</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">time</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
        <span style="color:#111">trades</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">name</span> <span style="color:#f92672">=</span> <span style="color:#111">None</span>
        
        <span style="color:#75715e"># fig = plt.figure()</span>
        <span style="color:#75715e"># ax = fig.add_subplot(111)</span>
        <span style="color:#75715e"># price.resample(&#39;1min&#39;).mean().dropna().plot(ax=ax, label=&#39;mid price&#39;, c=&#39;k&#39;)</span>
        <span style="color:#75715e"># trades[&#39;price&#39;].resample(&#39;1min&#39;).mean().dropna().plot(ax=ax, label=&#39;trade price&#39;, lw=0, marker=&#39;.&#39;, ms=1, c=&#39;r&#39;)</span>
        <span style="color:#75715e"># plt.ylabel(&#39;Price&#39;)</span>
        <span style="color:#75715e"># plt.title(f&#39;{pair}&#39;)</span>
        <span style="color:#75715e"># plt.xticks(ha=&#39;center&#39;, rotation=0)</span>
        <span style="color:#75715e"># plt.legend(frameon=False)</span>
        <span style="color:#75715e"># plt.tight_layout()</span>
        <span style="color:#75715e"># plt.show()</span>
        
        <span style="color:#111">tau</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>
        <span style="color:#111">T</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
        
        <span style="color:#111">tau</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">to_timedelta</span><span style="color:#111">(</span><span style="color:#111">tau</span><span style="color:#111">,</span> <span style="color:#111">unit</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">s</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
        <span style="color:#111">T</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">to_timedelta</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#111">,</span> <span style="color:#111">unit</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">s</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
        
        <span style="color:#00a8c8">def</span> <span style="color:#75af00">iterate</span><span style="color:#111">(</span><span style="color:#111">t</span><span style="color:#111">)</span><span style="color:#111">:</span>
            <span style="color:#111">nans</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">nan</span><span style="color:#111">,</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">nan</span><span style="color:#111">)</span>
            
            <span style="color:#111">sample_back</span> <span style="color:#f92672">=</span> <span style="color:#111">trades</span><span style="color:#111">[</span><span style="color:#111">t</span> <span style="color:#f92672">-</span> <span style="color:#111">tau</span><span style="color:#111">:</span><span style="color:#111">t</span><span style="color:#111">]</span>
            <span style="color:#111">entry_price</span> <span style="color:#f92672">=</span> <span style="color:#111">sample_back</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">:</span><span style="color:#111">t</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">price</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span>
            <span style="color:#111">sample_back</span> <span style="color:#f92672">=</span> <span style="color:#111">sample_back</span><span style="color:#111">[</span><span style="color:#111">sample_back</span><span style="color:#f92672">.</span><span style="color:#111">index</span> <span style="color:#f92672">&lt;</span> <span style="color:#111">t</span><span style="color:#111">]</span>
            <span style="color:#00a8c8">if</span> <span style="color:#f92672">not</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">sample_back</span><span style="color:#111">)</span><span style="color:#111">:</span> <span style="color:#00a8c8">return</span> <span style="color:#111">nans</span>
            <span style="color:#111">V</span> <span style="color:#f92672">=</span> <span style="color:#111">sample_back</span><span style="color:#f92672">.</span><span style="color:#111">groupby</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">side</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">size</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">sum</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">T</span><span style="color:#f92672">.</span><span style="color:#111">to_dict</span><span style="color:#111">(</span><span style="color:#111">)</span>
            <span style="color:#111">F</span> <span style="color:#f92672">=</span> <span style="color:#111">V</span><span style="color:#f92672">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">V</span><span style="color:#f92672">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
        
            <span style="color:#111">sample_forward</span> <span style="color:#f92672">=</span> <span style="color:#111">price</span><span style="color:#111">[</span><span style="color:#111">t</span><span style="color:#111">:</span><span style="color:#111">t</span> <span style="color:#f92672">+</span> <span style="color:#111">T</span><span style="color:#111">]</span>
            <span style="color:#00a8c8">if</span> <span style="color:#f92672">not</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">sample_forward</span><span style="color:#111">)</span><span style="color:#111">:</span> <span style="color:#00a8c8">return</span> <span style="color:#111">nans</span>
            <span style="color:#111">exit_price</span> <span style="color:#f92672">=</span> <span style="color:#111">sample_forward</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#75715e">## hold the position T seconds and then exit the position</span>
            <span style="color:#111">r</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">log</span><span style="color:#111">(</span><span style="color:#111">exit_price</span> <span style="color:#f92672">/</span> <span style="color:#111">entry_price</span><span style="color:#111">)</span>
        
            <span style="color:#00a8c8">return</span> <span style="color:#111">t</span><span style="color:#111">,</span> <span style="color:#111">F</span><span style="color:#111">,</span> <span style="color:#111">r</span>
        
        
        <span style="color:#111">results</span> <span style="color:#f92672">=</span> <span style="color:#111">p_map</span><span style="color:#111">(</span><span style="color:#111">iterate</span><span style="color:#111">,</span> <span style="color:#111">trades</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">unique</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
        <span style="color:#111">results</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">(</span><span style="color:#111">results</span><span style="color:#111">,</span> <span style="color:#111">columns</span><span style="color:#f92672">=</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">t</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">F</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">set_index</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">t</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
        <span style="color:#111">results</span> <span style="color:#f92672">=</span> <span style="color:#111">results</span><span style="color:#111">[</span><span style="color:#111">results</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">]</span>  <span style="color:#75715e"># this line is important - considering r = 0 cases are of no help here!</span>
        <span style="color:#111">results</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">name</span> <span style="color:#f92672">=</span> <span style="color:#111">None</span>
        <span style="color:#111">results</span><span style="color:#f92672">.</span><span style="color:#111">to_csv</span><span style="color:#111">(</span><span style="color:#111">filename</span><span style="color:#111">)</span>
    
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">result_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">../HW3/results_BTC-USD.csv</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">index_col</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">parse_dates</span><span style="color:#f92672">=</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">result_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">../HW3/results_ETH-USD.csv</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">index_col</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">parse_dates</span><span style="color:#f92672">=</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">result_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">../HW3/results_ETH-BTC.csv</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">index_col</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">parse_dates</span><span style="color:#f92672">=</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Note: from here, I use BTC/USD stock as an example to explicitly explain what this strategy does and how I improved it. Same logic for ETH/USD and ETH/BTC without detailed illustration.</p>
<h4 id="2--regression">2.  Regression</h4>
<p>Use the trade flow and returns we got from previous step to do the regression. Set the first 20% as the training set to do the regression to see the relationship between trade flow and returns.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">n_total_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">result_BTC_USD</span><span style="color:#111">)</span>
<span style="color:#111">n_train_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">round</span><span style="color:#111">(</span><span style="color:#111">n_total_BTC_USD</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.2</span><span style="color:#111">)</span>
<span style="color:#111">n_test_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">n_total_BTC_USD</span> <span style="color:#f92672">-</span> <span style="color:#111">n_train_BTC_USD</span>

<span style="color:#111">train_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">result_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#111">:</span><span style="color:#111">n_train_BTC_USD</span><span style="color:#111">]</span>
<span style="color:#111">test_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">result_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#111">n_test_BTC_USD</span><span style="color:#111">:</span><span style="color:#111">]</span>

<span style="color:#111">model_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">sm</span><span style="color:#f92672">.</span><span style="color:#111">ols</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r ~ F + 0</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">data</span><span style="color:#f92672">=</span><span style="color:#111">train_BTC_USD</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">fit</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">model_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">summary</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>

<span style="color:#111">beta_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">model_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">params</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">F</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                      r   R-squared:                       0.045
Model:                            OLS   Adj. R-squared:                  0.045
Method:                 Least Squares   F-statistic:                       nan
Date:                Thu, 30 Apr 2020   Prob (F-statistic):                nan
Time:                        17:19:19   Log-Likelihood:             6.3158e+05
No. Observations:              115954   AIC:                        -1.263e+06
Df Residuals:                  115953   BIC:                        -1.263e+06
Df Model:                           0                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
F           -5.75e-15    7.8e-17    -73.688      0.000    -5.9e-15    -5.6e-15
==============================================================================
Omnibus:                    14470.463   Durbin-Watson:                   0.031
Prob(Omnibus):                  0.000   Jarque-Bera (JB):           133593.069
Skew:                          -0.267   Prob(JB):                         0.00
Kurtosis:                       8.231   Cond. No.                         1.00
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">j</span> <span style="color:#f92672">=</span> <span style="color:#f92672">.</span><span style="color:#ae81ff">0001</span>

<span style="color:#111">fig</span> <span style="color:#f92672">=</span> <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">figure</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">ax</span> <span style="color:#f92672">=</span> <span style="color:#111">fig</span><span style="color:#f92672">.</span><span style="color:#111">add_subplot</span><span style="color:#111">(</span><span style="color:#ae81ff">111</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">axhspan</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">,</span> <span style="color:#111">j</span><span style="color:#111">,</span> <span style="color:#111">color</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">gray</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">alpha</span><span style="color:#f92672">=</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">scatter</span><span style="color:#111">(</span><span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span><span style="color:#111">,</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r</span><span style="color:#111">,</span> <span style="color:#111">s</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">k</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">Fmin_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span><span style="color:#f92672">.</span><span style="color:#111">min</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">Fmax_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span><span style="color:#f92672">.</span><span style="color:#111">max</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">(</span><span style="color:#111">Fmin_BTC_USD</span><span style="color:#111">,</span> <span style="color:#111">Fmax_BTC_USD</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#111">Fmin_BTC_USD</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_BTC_USD</span><span style="color:#111">,</span> <span style="color:#111">Fmax_BTC_USD</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_BTC_USD</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xlabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">F</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xlim</span><span style="color:#111">(</span><span style="color:#111">Fmin_BTC_USD</span><span style="color:#111">,</span> <span style="color:#111">Fmax_BTC_USD</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_11_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_BTC_USD</span>
<span style="color:#111">r_condition_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_BTC_USD</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_12_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_BTC_USD</span>
<span style="color:#111">r_condition_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_BTC_USD</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_13_0.png" alt="picture alt"></p>
<h4 id="3-prediction">3. Prediction</h4>
<p>After the regression, we use the left 80% data to be the testing set and use the coefficient we get from the regression to do the prediction of the return.</p>
<p>Then, compute the daily pnl and cumulative pnlto see the returns.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">T</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
<span style="color:#111">T</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">to_timedelta</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#111">,</span> <span style="color:#111">unit</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">s</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">scaler_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">T</span> <span style="color:#f92672">/</span> <span style="color:#111">result_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">to_series</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">diff</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
<span style="color:#111">pnl_train_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_BTC_USD</span>
<span style="color:#111">cumpnl_train_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">cumpnl_train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">k</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">train</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">test_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_BTC_USD</span>
<span style="color:#111">test_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
<span style="color:#111">pnl_test_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_BTC_USD</span>
<span style="color:#111">cumpnl_test_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">(</span><span style="color:#111">cumpnl_test_BTC_USD</span> <span style="color:#f92672">+</span> <span style="color:#111">cumpnl_train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">test</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvspan</span><span style="color:#111">(</span><span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">color</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">gray</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">alpha</span><span style="color:#f92672">=</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xticks</span><span style="color:#111">(</span><span style="color:#111">ha</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">center</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">rotation</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">legend</span><span style="color:#111">(</span><span style="color:#111">frameon</span><span style="color:#f92672">=</span><span style="color:#111">False</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Cum PnL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_15_0.png" alt="picture alt"></p>
<p>I also want to use three indexes to judge if the strategy is good enough.</p>
<p>They are:</p>
<ul>
<li>Sharpe Ratio: return of an investment compared to its risk</li>
<li>Maximnm Drawdown: maximum observed loss from a peak to a trough</li>
<li>Winning Rate: the percentage of winning</li>
</ul>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">def</span> <span style="color:#75af00">sharpe</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">x</span> <span style="color:#f92672">=</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">resample</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">1min</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span>  <span style="color:#75715e"># resample to 1min to calculate sharpe ratio</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#ae81ff">252</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">std</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">if</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">std</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">else</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">nan</span><span style="color:#111">)</span>

<span style="color:#00a8c8">def</span> <span style="color:#75af00">win_rate</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">sum</span><span style="color:#111">(</span><span style="color:#111">x</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#111">sum</span><span style="color:#111">(</span><span style="color:#111">x</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#00a8c8">if</span> <span style="color:#111">any</span><span style="color:#111">(</span><span style="color:#111">x</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#00a8c8">else</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">nan</span><span style="color:#111">)</span>

<span style="color:#00a8c8">def</span> <span style="color:#75af00">maximum_drawdown</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">:</span>  <span style="color:#75715e"># use absolute drawdown instead of percentage here -&gt; cum pnl could be negative</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">cummax</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">max</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">train: sharpe={sharpe(pnl_train_BTC_USD):.2f}, win</span><span style="color:#d88200">%</span><span style="color:#d88200">={win_rate(pnl_train_BTC_USD):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}, mdd={maximum_drawdown(cumpnl_train_BTC_USD):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200"> test: sharpe={sharpe(pnl_test_BTC_USD):.2f}, win</span><span style="color:#d88200">%</span><span style="color:#d88200">={win_rate(pnl_test_BTC_USD):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}, mdd={maximum_drawdown(cumpnl_test_BTC_USD):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>train: sharpe=62.78, win%=67.39%, mdd=17.62%
 test: sharpe=70.11, win%=69.24%, mdd=12.37%
</code></pre>
<h3 id="3-parameter-tuning">3. Parameter Tuning</h3>
<p>Clearly, choosing thresholds by hands is not working here. It&rsquo;s not efficient. More importantly, it&rsquo;s not gonna help us find the best strategy. That&rsquo;s why we should do the parameter tuning here. We should use training dataset to do the parameter tuning since the prediction part is where we use the strategy to predict, if we use predict dataset, then we&rsquo;re using forward information, which doesn&rsquo;t make sense when it comes to the real world situation.</p>
<h4 id="set-parameter-grid">Set parameter grid</h4>
<p>For threshold j, from the scatter plot of the trade of training set, I choose the grid grom (0.00001, 0.0031). I used a for-loop to do the parameter tuning. There&rsquo;re three indexes but I will use sharpe ratio as our standard here(this is the limitatoin of this way of parameter tuning: we could not look at all the indexed at the same time).</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">max_sharpe</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#111">float</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">inf</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>


<span style="color:#00a8c8">for</span> <span style="color:#111">j</span> <span style="color:#f92672">in</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">arange</span><span style="color:#111">(</span><span style="color:#ae81ff">0.00001</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.0031</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.00001</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">scaler_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">T</span> <span style="color:#f92672">/</span> <span style="color:#111">result_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">to_series</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">diff</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span>

    <span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_BTC_USD</span>
    <span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
    <span style="color:#111">pnl_train_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_BTC_USD</span>
    <span style="color:#111">cumpnl_train_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
    
    <span style="color:#111">sharpe_ratio_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">sharpe</span><span style="color:#111">(</span><span style="color:#111">pnl_train_BTC_USD</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">sharpe_ratio_BTC_USD</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">max_sharpe</span><span style="color:#111">:</span>
        <span style="color:#111">max_sharpe</span> <span style="color:#f92672">=</span> <span style="color:#111">sharpe_ratio_BTC_USD</span>
        <span style="color:#111">best_j_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">j</span>
        <span style="color:#111">win_rate_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">win_rate</span><span style="color:#111">(</span><span style="color:#111">pnl_train_BTC_USD</span><span style="color:#111">)</span>
        <span style="color:#111">mmd_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">maximum_drawdown</span><span style="color:#111">(</span><span style="color:#111">pnl_train_BTC_USD</span><span style="color:#111">)</span>
        <span style="color:#111">best_cumpnl_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
        

<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The best j is {best_j_BTC_USD}.</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The Sharpe Ratio of the strategy is {max_sharpe}.</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The winning rate of the strategy is {win_rate_BTC_USD}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The maximum drawdown of the strategy is {mmd_BTC_USD}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The best j is 1e-05.
The Sharpe Ratio of the strategy is 138.22206028441337.
The winning rate of the strategy is 0.6478998487105753
The maximum drawdown of the strategy is 0.0018669595589803668
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_BTC_USD</span>
<span style="color:#111">r_condition_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">best_j_BTC_USD</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_BTC_USD</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_20_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_BTC_USD</span>
<span style="color:#111">r_condition_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">best_j_BTC_USD</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_BTC_USD</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_21_0.png" alt="picture alt"></p>
<h4 id="prediction-after-parameter-tuning">Prediction after parameter tuning</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">test_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_BTC_USD</span>
<span style="color:#111">test_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">best_j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">best_j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
<span style="color:#111">pnl_test_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_BTC_USD</span>
<span style="color:#111">cumpnl_test_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_test_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">(</span><span style="color:#111">cumpnl_test_BTC_USD</span> <span style="color:#f92672">+</span> <span style="color:#111">cumpnl_train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">test</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvspan</span><span style="color:#111">(</span><span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">color</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">gray</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">alpha</span><span style="color:#f92672">=</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xticks</span><span style="color:#111">(</span><span style="color:#111">ha</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">center</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">rotation</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">legend</span><span style="color:#111">(</span><span style="color:#111">frameon</span><span style="color:#f92672">=</span><span style="color:#111">False</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Cum PnL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">title</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Cum Pnl of BTC/USD After Parameter Tuning</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200"> test: sharpe={sharpe(pnl_test_BTC_USD):.2f}, win</span><span style="color:#d88200">%</span><span style="color:#d88200">={win_rate(pnl_test_BTC_USD):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}, mdd={maximum_drawdown(cumpnl_test_BTC_USD):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_23_0.png" alt="picture alt"></p>
<pre><code> test: sharpe=170.44, win%=63.18%, mdd=8.97%
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_BTC_USD</span>
<span style="color:#111">r_condition_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_BTC_USD</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p>From the result, we could see that after the parameter tuning, the strategy improves a lot.</p>
<h3 id="regression-prediction-and-parameter-tuning-for-eth_usd">Regression, prediction and parameter tuning for ETH_USD.</h3>
<h4 id="regression">Regression</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">n_total_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">result_ETH_USD</span><span style="color:#111">)</span>
<span style="color:#111">n_train_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">round</span><span style="color:#111">(</span><span style="color:#111">n_total_ETH_USD</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.2</span><span style="color:#111">)</span>
<span style="color:#111">n_test_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">n_total_ETH_USD</span> <span style="color:#f92672">-</span> <span style="color:#111">n_train_ETH_USD</span>

<span style="color:#111">train_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">result_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#111">:</span><span style="color:#111">n_train_ETH_USD</span><span style="color:#111">]</span>
<span style="color:#111">test_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">result_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#111">n_test_ETH_USD</span><span style="color:#111">:</span><span style="color:#111">]</span>

<span style="color:#111">model_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">sm</span><span style="color:#f92672">.</span><span style="color:#111">ols</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r ~ F + 0</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">data</span><span style="color:#f92672">=</span><span style="color:#111">train_ETH_USD</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">fit</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">model_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">summary</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>

<span style="color:#111">beta_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">model_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">params</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">F</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                      r   R-squared:                       0.001
Model:                            OLS   Adj. R-squared:                  0.001
Method:                 Least Squares   F-statistic:                       nan
Date:                Thu, 30 Apr 2020   Prob (F-statistic):                nan
Time:                        17:24:53   Log-Likelihood:             4.2046e+05
No. Observations:               77223   AIC:                        -8.409e+05
Df Residuals:                   77222   BIC:                        -8.409e+05
Df Model:                           0                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
F          -2.068e-16   1.59e-17    -12.995      0.000   -2.38e-16   -1.76e-16
==============================================================================
Omnibus:                     7565.669   Durbin-Watson:                   0.093
Prob(Omnibus):                  0.000   Jarque-Bera (JB):            54132.427
Skew:                          -0.173   Prob(JB):                         0.00
Kurtosis:                       7.087   Cond. No.                         1.00
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">j</span> <span style="color:#f92672">=</span> <span style="color:#f92672">.</span><span style="color:#ae81ff">00001</span>

<span style="color:#111">fig</span> <span style="color:#f92672">=</span> <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">figure</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">ax</span> <span style="color:#f92672">=</span> <span style="color:#111">fig</span><span style="color:#f92672">.</span><span style="color:#111">add_subplot</span><span style="color:#111">(</span><span style="color:#ae81ff">111</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">axhspan</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">,</span> <span style="color:#111">j</span><span style="color:#111">,</span> <span style="color:#111">color</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">gray</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">alpha</span><span style="color:#f92672">=</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">scatter</span><span style="color:#111">(</span><span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span><span style="color:#111">,</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r</span><span style="color:#111">,</span> <span style="color:#111">s</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">k</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">Fmin_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span><span style="color:#f92672">.</span><span style="color:#111">min</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">Fmax_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span><span style="color:#f92672">.</span><span style="color:#111">max</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">(</span><span style="color:#111">Fmin_ETH_USD</span><span style="color:#111">,</span> <span style="color:#111">Fmax_ETH_USD</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#111">Fmin_ETH_USD</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_USD</span><span style="color:#111">,</span> <span style="color:#111">Fmax_ETH_USD</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_USD</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xlabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">F</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xlim</span><span style="color:#111">(</span><span style="color:#111">Fmin_ETH_USD</span><span style="color:#111">,</span> <span style="color:#111">Fmax_ETH_USD</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_28_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_USD</span>
<span style="color:#111">r_condition_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_ETH_USD</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_29_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_USD</span>
<span style="color:#111">r_condition_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_ETH_USD</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_30_0.png" alt="picture alt"></p>
<h4 id="prediction">Prediction</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">scaler_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">T</span> <span style="color:#f92672">/</span> <span style="color:#111">result_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">to_series</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">diff</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_USD</span>
<span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
<span style="color:#111">pnl_train_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_ETH_USD</span>
<span style="color:#111">cumpnl_train_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">cumpnl_train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">k</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">train</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">test_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_USD</span>
<span style="color:#111">test_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
<span style="color:#111">pnl_test_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_ETH_USD</span>
<span style="color:#111">cumpnl_test_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">(</span><span style="color:#111">cumpnl_test_ETH_USD</span> <span style="color:#f92672">+</span> <span style="color:#111">cumpnl_train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">test</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvspan</span><span style="color:#111">(</span><span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">color</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">gray</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">alpha</span><span style="color:#f92672">=</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xticks</span><span style="color:#111">(</span><span style="color:#111">ha</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">center</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">rotation</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">legend</span><span style="color:#111">(</span><span style="color:#111">frameon</span><span style="color:#f92672">=</span><span style="color:#111">False</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Cum PnL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_32_0.png" alt="picture alt"></p>
<h4 id="parameter-tuning">Parameter tuning</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">max_sharpe</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#111">float</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">inf</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>


<span style="color:#00a8c8">for</span> <span style="color:#111">j</span> <span style="color:#f92672">in</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">arange</span><span style="color:#111">(</span><span style="color:#ae81ff">0.000001</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.00031</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.00001</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">scaler_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">T</span> <span style="color:#f92672">/</span> <span style="color:#111">result_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">to_series</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">diff</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span>

    <span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_USD</span>
    <span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
    <span style="color:#111">pnl_train_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_ETH_USD</span>
    <span style="color:#111">cumpnl_train_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
    
    <span style="color:#111">sharpe_ratio_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">sharpe</span><span style="color:#111">(</span><span style="color:#111">pnl_train_ETH_USD</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">sharpe_ratio_ETH_USD</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">max_sharpe</span><span style="color:#111">:</span>
        <span style="color:#111">max_sharpe</span> <span style="color:#f92672">=</span> <span style="color:#111">sharpe_ratio_ETH_USD</span>
        <span style="color:#111">best_j_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">j</span>
        <span style="color:#111">win_rate_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">win_rate</span><span style="color:#111">(</span><span style="color:#111">pnl_train_ETH_USD</span><span style="color:#111">)</span>
        <span style="color:#111">mmd_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">maximum_drawdown</span><span style="color:#111">(</span><span style="color:#111">pnl_train_ETH_USD</span><span style="color:#111">)</span>
        <span style="color:#111">best_cumpnl_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
        

<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The best j is {best_j_ETH_USD}.</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The Sharpe Ratio of the strategy is {max_sharpe}.</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The winning rate of the strategy is {win_rate_ETH_USD}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The maximum drawdown of the strategy is {mmd_ETH_USD}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The best j is 1e-06.
The Sharpe Ratio of the strategy is 88.34463957625027.
The winning rate of the strategy is 0.5707598391688433
The maximum drawdown of the strategy is 0.0028059184190173114
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_USD</span>
<span style="color:#111">r_condition_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">best_j_ETH_USD</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_ETH_USD</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_35_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_USD</span>
<span style="color:#111">r_condition_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">best_j_ETH_USD</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_ETH_USD</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_36_0.png" alt="picture alt"></p>
<h4 id="prediction-after-parameter-tuning-1">Prediction after parameter tuning</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">test_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_USD</span>
<span style="color:#111">test_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">best_j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">best_j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
<span style="color:#111">pnl_test_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_ETH_USD</span>
<span style="color:#111">cumpnl_test_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_test_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">(</span><span style="color:#111">cumpnl_test_ETH_USD</span> <span style="color:#f92672">+</span> <span style="color:#111">cumpnl_train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">test</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvspan</span><span style="color:#111">(</span><span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">train_ETH_USD</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">color</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">gray</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">alpha</span><span style="color:#f92672">=</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xticks</span><span style="color:#111">(</span><span style="color:#111">ha</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">center</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">rotation</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">legend</span><span style="color:#111">(</span><span style="color:#111">frameon</span><span style="color:#f92672">=</span><span style="color:#111">False</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Cum PnL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">title</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Cum Pnl of ETH/USD After Parameter Tuning</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200"> test: sharpe={sharpe(pnl_test_ETH_USD):.2f}, win</span><span style="color:#d88200">%</span><span style="color:#d88200">={win_rate(pnl_test_ETH_USD):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}, mdd={maximum_drawdown(cumpnl_test_ETH_USD):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_38_0.png" alt="picture alt"></p>
<pre><code> test: sharpe=84.63, win%=57.87%, mdd=225.42%
</code></pre>
<h3 id="regression-prediction-and-parameter-tuning-for-eth_btc">Regression, prediction and parameter tuning for ETH_BTC.</h3>
<h4 id="regression-1">Regression</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">n_total_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">result_ETH_BTC</span><span style="color:#111">)</span>
<span style="color:#111">n_train_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">round</span><span style="color:#111">(</span><span style="color:#111">n_total_ETH_BTC</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.2</span><span style="color:#111">)</span>
<span style="color:#111">n_test_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">n_total_ETH_BTC</span> <span style="color:#f92672">-</span> <span style="color:#111">n_train_ETH_BTC</span>

<span style="color:#111">train_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">result_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#111">:</span><span style="color:#111">n_train_ETH_BTC</span><span style="color:#111">]</span>
<span style="color:#111">test_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">result_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#111">n_test_ETH_BTC</span><span style="color:#111">:</span><span style="color:#111">]</span>

<span style="color:#111">model_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">sm</span><span style="color:#f92672">.</span><span style="color:#111">ols</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r ~ F + 0</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">data</span><span style="color:#f92672">=</span><span style="color:#111">train_ETH_BTC</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">fit</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">model_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">summary</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>

<span style="color:#111">beta_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">model_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">params</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">F</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>                                 OLS Regression Results                                
=======================================================================================
Dep. Variable:                      r   R-squared (uncentered):                   0.023
Model:                            OLS   Adj. R-squared (uncentered):              0.023
Method:                 Least Squares   F-statistic:                              124.9
Date:                Thu, 30 Apr 2020   Prob (F-statistic):                    1.14e-28
Time:                        17:25:33   Log-Likelihood:                          31030.
No. Observations:                5284   AIC:                                 -6.206e+04
Df Residuals:                    5283   BIC:                                 -6.205e+04
Df Model:                           1                                                  
Covariance Type:            nonrobust                                                  
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
F          -1.737e-15   1.55e-16    -11.175      0.000   -2.04e-15   -1.43e-15
==============================================================================
Omnibus:                     1556.944   Durbin-Watson:                   0.272
Prob(Omnibus):                  0.000   Jarque-Bera (JB):            19677.407
Skew:                          -1.045   Prob(JB):                         0.00
Kurtosis:                      12.220   Cond. No.                         1.00
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">j</span> <span style="color:#f92672">=</span> <span style="color:#f92672">.</span><span style="color:#ae81ff">00001</span>

<span style="color:#111">fig</span> <span style="color:#f92672">=</span> <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">figure</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">ax</span> <span style="color:#f92672">=</span> <span style="color:#111">fig</span><span style="color:#f92672">.</span><span style="color:#111">add_subplot</span><span style="color:#111">(</span><span style="color:#ae81ff">111</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">axhspan</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">,</span> <span style="color:#111">j</span><span style="color:#111">,</span> <span style="color:#111">color</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">gray</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">alpha</span><span style="color:#f92672">=</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">scatter</span><span style="color:#111">(</span><span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">F</span><span style="color:#111">,</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r</span><span style="color:#111">,</span> <span style="color:#111">s</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">k</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">Fmin_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">F</span><span style="color:#f92672">.</span><span style="color:#111">min</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">Fmax_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">F</span><span style="color:#f92672">.</span><span style="color:#111">max</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">ax</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">(</span><span style="color:#111">Fmin_ETH_BTC</span><span style="color:#111">,</span> <span style="color:#111">Fmax_ETH_BTC</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#111">Fmin_ETH_BTC</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_BTC</span><span style="color:#111">,</span> <span style="color:#111">Fmax_ETH_BTC</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_BTC</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xlabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">F</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xlim</span><span style="color:#111">(</span><span style="color:#111">Fmin_ETH_BTC</span><span style="color:#111">,</span> <span style="color:#111">Fmax_ETH_BTC</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_41_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_BTC</span>
<span style="color:#111">r_condition_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_ETH_BTC</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_42_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_BTC</span>
<span style="color:#111">r_condition_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_ETH_BTC</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_43_0.png" alt="picture alt"></p>
<h4 id="prediction-1">Prediction</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">scaler_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">T</span> <span style="color:#f92672">/</span> <span style="color:#111">result_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">to_series</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">diff</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span>

<span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_BTC</span>
<span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
<span style="color:#111">pnl_train_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_ETH_BTC</span>
<span style="color:#111">cumpnl_train_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">cumpnl_train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">k</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">train</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">test_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_BTC</span>
<span style="color:#111">test_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
<span style="color:#111">pnl_test_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_ETH_BTC</span>
<span style="color:#111">cumpnl_test_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">(</span><span style="color:#111">cumpnl_test_ETH_BTC</span> <span style="color:#f92672">+</span> <span style="color:#111">cumpnl_train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">test</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvspan</span><span style="color:#111">(</span><span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">color</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">gray</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">alpha</span><span style="color:#f92672">=</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xticks</span><span style="color:#111">(</span><span style="color:#111">ha</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">center</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">rotation</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">legend</span><span style="color:#111">(</span><span style="color:#111">frameon</span><span style="color:#f92672">=</span><span style="color:#111">False</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Cum PnL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_45_0.png" alt="picture alt"></p>
<h4 id="parameter-tuning-1">Parameter tuning</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">max_sharpe</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#111">float</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">inf</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>


<span style="color:#00a8c8">for</span> <span style="color:#111">j</span> <span style="color:#f92672">in</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">arange</span><span style="color:#111">(</span><span style="color:#ae81ff">0.00001</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.00031</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.0001</span><span style="color:#111">)</span><span style="color:#111">:</span>
    <span style="color:#111">scaler_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">T</span> <span style="color:#f92672">/</span> <span style="color:#111">result_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">to_series</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">diff</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">)</span>

    <span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_BTC</span>
    <span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
    <span style="color:#111">pnl_train_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_ETH_BTC</span>
    <span style="color:#111">cumpnl_train_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
    
    <span style="color:#111">sharpe_ratio_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">sharpe</span><span style="color:#111">(</span><span style="color:#111">pnl_train_ETH_BTC</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">sharpe_ratio_ETH_BTC</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">max_sharpe</span><span style="color:#111">:</span>
        <span style="color:#111">max_sharpe</span> <span style="color:#f92672">=</span> <span style="color:#111">sharpe_ratio_ETH_BTC</span>
        <span style="color:#111">best_j_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">j</span>
        <span style="color:#111">win_rate_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">win_rate</span><span style="color:#111">(</span><span style="color:#111">pnl_train_ETH_BTC</span><span style="color:#111">)</span>
        <span style="color:#111">mmd_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">maximum_drawdown</span><span style="color:#111">(</span><span style="color:#111">pnl_train_ETH_BTC</span><span style="color:#111">)</span>
        <span style="color:#111">best_cumpnl_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
        

<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The best j is {best_j_ETH_BTC}.</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The Sharpe Ratio of the strategy is {max_sharpe}.</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The winning rate of the strategy is {win_rate_ETH_BTC}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">The maximum drawdown of the strategy is {mmd_ETH_BTC}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The best j is 1e-05.
The Sharpe Ratio of the strategy is 42.72009942602687.
The winning rate of the strategy is 0.4245207667731629
The maximum drawdown of the strategy is 0.0250970167057089
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_BTC</span>
<span style="color:#111">r_condition_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">best_j_ETH_BTC</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_ETH_BTC</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_48_0.png" alt="picture alt"></p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_BTC</span>
<span style="color:#111">r_condition_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">best_j_ETH_BTC</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">r</span>
<span style="color:#111">sns</span><span style="color:#f92672">.</span><span style="color:#111">distplot</span><span style="color:#111">(</span><span style="color:#111">r_condition_ETH_BTC</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvline</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_49_0.png" alt="picture alt"></p>
<h4 id="prediction-after-parameter-tuning-2">Prediction after parameter tuning</h4>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">test_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">F</span> <span style="color:#f92672">*</span> <span style="color:#111">beta_ETH_BTC</span>
<span style="color:#111">test_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">pos</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">best_j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#111">(</span><span style="color:#111">test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r_hat</span> <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#111">best_j</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">)</span>
<span style="color:#111">pnl_test_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">pos</span> <span style="color:#f92672">*</span> <span style="color:#111">test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">r</span> <span style="color:#f92672">/</span> <span style="color:#111">scaler_ETH_BTC</span>
<span style="color:#111">cumpnl_test_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">pnl_test_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">cumsum</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">(</span><span style="color:#111">cumpnl_test_ETH_BTC</span> <span style="color:#f92672">+</span> <span style="color:#111">cumpnl_train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">c</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">test</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">axvspan</span><span style="color:#111">(</span><span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">color</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">gray</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">alpha</span><span style="color:#f92672">=</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>

<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xticks</span><span style="color:#111">(</span><span style="color:#111">ha</span><span style="color:#f92672">=</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">center</span><span style="color:#d88200">&#39;</span><span style="color:#111">,</span> <span style="color:#111">rotation</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">legend</span><span style="color:#111">(</span><span style="color:#111">frameon</span><span style="color:#f92672">=</span><span style="color:#111">False</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Cum PnL</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">title</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">Cum Pnl of ETH/BTC After Parameter Tuning</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">tight_layout</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200"> test: sharpe={sharpe(pnl_test_ETH_BTC):.2f}, win</span><span style="color:#d88200">%</span><span style="color:#d88200">={win_rate(pnl_test_ETH_BTC):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}, mdd={maximum_drawdown(cumpnl_test_ETH_BTC):.2</span><span style="color:#d88200">%</span><span style="color:#d88200">}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/trade_flow/output_51_0.png" alt="picture alt"></p>
<pre><code> test: sharpe=84.86, win%=58.19%, mdd=64.28%
</code></pre>
<h2 id="3-analysis">3. Analysis</h2>
<h3 id="1-reliability-of-beta-of-regression-model">1. Reliability of $\beta$ of regression model</h3>
<p>To assess the the realiability of a regression model, there&rsquo;re several statistics that we could take a look at:</p>
<ul>
<li>
<p><strong>$R^2$</strong>: the $R^2$ in regression analysis measures the proportion of variation in the dependent variable which is explained by the variation of independent variable. More often, we use <strong>Adjusted $R^2$</strong> to meansure the model since it makes correction and avoids some bias of $R^2$. The lower $R^2$ is, the less accurate and reliable that the model could predict the relationship between the dependent and independent variables.</p>
</li>
<li>
<p><strong>RMSE</strong>: the square root of the variance of the residuals could indicate the absolute fit of the model and see how close the model&rsquo;s prediction points are to the real data. Lower RMSE indicates better fit, which implies more reliability of the regression&rsquo;s $\beta$.</p>
</li>
</ul>
<p>Here&rsquo;s the analysis of three different regression models:</p>
<ul>
<li>
<p>For BTC/USD:</p>
<ul>
<li>$R^2$ is 0.045 (4.5%). This is relatively small.</li>
<li><strong>RMSE</strong>: 0.001</li>
</ul>
</li>
<li>
<p>For ETH/USD:</p>
<ul>
<li>$R^2$ is 0.001 (0.1%). This is very small.</li>
<li><strong>RMSE</strong>: 0.001</li>
</ul>
</li>
<li>
<p>For ETH/BTC:</p>
<ul>
<li>$R^2$ is 0.023 (2.3%). This is very small.</li>
<li><strong>RMSE</strong>: 0.0007</li>
</ul>
</li>
</ul>
<p>From the result we got, all of the three regression models did not do well and their $\beta$s are all not that reliable. From my understanding, the inaccuracy of the regression is caused because there&rsquo;re too many noises in the market. What&rsquo;s more, since the stock price dynamics is a Brownian motion, it&rsquo;s hard to just use a single regression model to build the relationship.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">rmse_BTC_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">sqrt</span><span style="color:#111">(</span><span style="color:#111">mean_squared_error</span><span style="color:#111">(</span><span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">train_BTC_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">rmse_BTC_USD</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>0.0010428840794850756
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">rmse_ETH_USD</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">sqrt</span><span style="color:#111">(</span><span style="color:#111">mean_squared_error</span><span style="color:#111">(</span><span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">train_ETH_USD</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">rmse_ETH_USD</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>0.0010450202187856708
</code></pre>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">rmse_ETH_BTC</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">sqrt</span><span style="color:#111">(</span><span style="color:#111">mean_squared_error</span><span style="color:#111">(</span><span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">train_ETH_BTC</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">r_hat</span><span style="color:#d88200">&#39;</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">rmse_ETH_BTC</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>0.0006813993737101344
</code></pre>
<h3 id="2-how-to-choose-j-in-this-strategy">2. How to choose j in this strategy?</h3>
<p>Intuitively, we want to choose j such that when $\hat{r}$ &gt; j, r&rsquo;s distribution is left-skewed; when $\hat{r}$ &lt; -j, r&rsquo;s distribution is right-skewed. We could not choose a too-large j since the threshold is too high to trade. Also, we could not choose a too-small j sinche when the ghreshold is too low, there&rsquo;s no point of having a threshold.</p>
<p>Before we choose the j, I randomly picked j = 0.00001 and from their distribution plot, we could see that the distribution of r is not what we want. After parameter tuning, I plotted the distribution of r again and we could see the distribution plots are relatively closer to what we expect here.</p>
<h3 id="3-much-longer-training-and-test-period">3. Much longer training and test period?</h3>
<p>From my understanding, with much longer training and test period, the strategy will become less reliable and the return will be much less attempting.</p>
<p>Cryptotoken market is a market with no underlying, so it is less likely that there&rsquo;re informed diretional traders than the underlying markets, which means we could not be sure that along the five days we&rsquo;re computing, the traders who were trading are informed traders. These five days could be a coincidence that people just happened to enter the cryptotoken market and began trading. The cryptotoken market is even more stochastic than the underlying market so the relationship between the signal (trade flow) and the return is very likely to change given a much longer time period. That&rsquo;s why I thought the strategy will be less effective.</p>

      </div>


      <footer>
        


        
        
        <script src="https://utteranc.es/client.js"
  repo= "christineeeeee/christineeeeee.github.io"
  issue-term="pathname"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script>
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
    
    
    
  </section>

</footer>

    </main>

    

  </body>

</html>
